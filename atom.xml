<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Rainer's blog]]></title>
  <link href="http://Robing.github.io/atom.xml" rel="self"/>
  <link href="http://Robing.github.io/"/>
  <updated>2014-07-28T14:07:02+08:00</updated>
  <id>http://Robing.github.io/</id>
  <author>
    <name><![CDATA[Robin]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[浏览器的历史记录]]></title>
    <link href="http://Robing.github.io/blog/2014/06/20/history/"/>
    <updated>2014-06-20T14:58:25+08:00</updated>
    <id>http://Robing.github.io/blog/2014/06/20/history</id>
    <content type="html"><![CDATA[<div>
    <h3>老的History概览</h3>
    <p>
        window对象的history是一组包含最近访问过的url的数组，但是出于安全和用户隐私方面的考虑，脚本不能真正的访问这组数组原色。不过它提供了以下3个方法：
        <ul class="txtlist">
            <li>back(): 在历史记录中后退，等同于浏览器的后退按钮</li>
            <li>forword(): 在历史记录中前进，等同于浏览器的前进按钮</li>
            <li>go(): 通过指定一个特定的数值（相对于当前页，当前页是0，如果是正值，就前进几个记录，如果是负值就后退几个历史记录）；例如go(2)就是向前移动2页，go(-1)就是后退一页，go(0)就是刷新当前页面</li>
        </ul>
        <p>你可以通过length属性查看history数组中存放了多少历史记录</p>
    </p>
    <h3>HTML5新增方法</h3>
    <p>
        HTML5引进了history.pushState()方法和history.replaceState()方法，它们允许你逐条地添加和修改历史记录条目。这些方法可以协同window.onpopstate事件一起工作。
    </p>
    <h3 id="pushState().E6.96.B9.E6.B3.95">pushState()方法</h3>
    <p>pushState()有三个参数：一个状态对象、一个标题（现在会被忽略），一个可选的URL地址。下面来单独考察这三个参数的细节：</p>
    <ul class="txtlist">
      <li>
        <p><strong>状态对象（state object）</strong> — 一个JavaScript对象，与用pushState()方法创建的新历史记录条目关联。无论何时用户导航到新创建的状态，popstate事件都会被触发，并且通过事件对象的state属性都可以访问到找个状态对象。</p>
        <p>任何可序列化的对象都可以被当做状态对象。FireFox浏览器会把状态对象保存到用户的硬盘，这样它们就能在用户重启浏览器之后被还原，我们强行限制状态对象的大小为640k。如果你向pushState()方法传递了一个超过该限额的状态对象，该方法会抛出异常。如果你需要存储很大的数据，建议使用sessionStorage或localStorage。</p>
      </li>
      <li>
        <p><strong>标题（title）</strong> — FireFox浏览器目前会忽略该参数，虽然以后可能会用上。考虑到未来可能会对该方法进行修改，传一个空字符串会比较安全。或者，你也可以传入一个简短的标题，标明将要进入的状态。</p>
      </li>
      <li>
        <p><strong>地址（URL）</strong> — 新的历史记录条目的地址。浏览器不会在调用pushState()方法后加载该地址，但之后，可能会试图加载，例如用户重启浏览器。新的URL不一定是绝对路径；如果是相对路径，它将以当前URL为基准；传入的URL与当前URL应该是同源的，否则，pushState()会抛出异常。该参数是可选的；不指定的话则为文档当前URL。</p>
      </li>
    </ul>
    <!-- more -->
    <h3>案例</h3>
    假设 http://xxx.com/foo.html 将执行如下JavaScript代码：
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>       <span class="kd">var</span> <span class="nx">stateObj</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">&quot;bar&quot;</span> <span class="p">};</span>
</span><span class='line'>      <span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span><span class="p">(</span><span class="nx">stateObj</span><span class="p">,</span> <span class="s2">&quot;page 2&quot;</span><span class="p">,</span> <span class="s2">&quot;bar.html&quot;</span><span class="p">);</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>

    这将让浏览器的地址栏显示http://xxx.com/bar.html，但不会加载bar.html页面也不会检查bar.html是否存在。<br>
    <p>假设现在用户输入了新的网址到了http://google.com，然后点击了后退按钮，此时，地址栏将会显示http://xxx.com/bar.html，并且页面会触发popstate事件，该事件中的状态对象（state object）包含stateObj的一个拷贝。该页面看起来像foo.html，尽管页面内容可能在popstate事件中被修改。如果我们再次点击后退按钮，URL将变回http://xxx.com/foo.html，文档将触发另一个popstate事件，这次的状态对象为null。回退同样不会改变文档内容。</p>
    <p>某种意义上，调用pushState()有点类似于设置window.location=&#8217;#foo&#8217;，它们都会在当前文档内创建和激活新的历史记录条目。但pushState()有自己的优势：</p>
    <ul>
      <li>新的URL可以是任意的同源URL，与此相反，使用window.location方法时，只有仅修改hash才能保证停留在相同的<a href="http://Robing.github.io/zh-CN/docs/DOM/document" title="此页面仍未被本地化, 期待您的翻译!"><code>document</code></a>中。</li>
      <li>根据个人需要来决定是否修改URL。相反，设置window.location=&#8217;#foo&#8217;，只有在当前hash值不是foo时才创建一条新历史记录。</li>
      <li>你可以在新添加的历史记录条目中添加相关联的数据。如果使用基于hash的方法，你只能把相关数据转码成一个很短的字符串。</li>
    </ul>
    <p>注意pushState()方法永远不会触发hashchange事件，即便新的地址只变更了hash。</p>
    <h3 id="">replaceState()方法</h3>
    <p>history.replaceState()操作类似于history.pushState()，不同之处在于replaceState()方法会修改当前历史记录条目而并非创建新的条目。</p>
    <p>当你为了响应用户的某些操作，而要更新当前历史记录条目的状态对象或URL时，使用replaceState()方法会特别合适。</p>
    <p>每当激活的历史记录发生变化时，都会触发popstate事件。如果被激活的历史记录条目是由pushState所创建，或是被replaceState方法影响到的，popstate事件的状态属性将包含历史记录的状态对象的一个拷贝。</p>
    <h3 id="">读取当前状态</h3>
    <p>在页面加载时，可能会包含一个非空的状态对象。这种情况是会发生的，例如，如果页面中使用pushState()或replaceState()方法设置了一个状态对象，然后用户重启了浏览器。当页面重新加载时，页面会触发onload事件，但不会触发popstate事件。但是，如果你读取&nbsp;<span style="font-family: Courier New;">history.state</span>&nbsp;属性，你会得到一个与&nbsp;<span style="line-height: inherit;">&nbsp;</span><span style="line-height: inherit; font-family: 'Courier New';">popstate 事件触发时得到的一样的状态对象。</span></p>
    <p>你可以直接读取当前历史记录条目的状态，而不需要等待popstate事件：</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>   <span class="kd">var</span> <span class="nx">currentState</span> <span class="o">=</span> <span class="nx">history</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>

    <h2 id="">浏览器兼容性</h2>
    <table class="table">
    <tbody>
      <tr>
        <th>Feature</th>
        <th>Chrome</th>
        <th>Firefox (Gecko)</th>
        <th>Internet Explorer</th>
        <th>Opera</th>
        <th>Safari</th>
      </tr>
      <tr>
        <td>replaceState, pushState</td>
        <td>5</td>
        <td><a href="http://Robing.github.io/en-US/Firefox/Releases/4" title="Released on 2011-03-22.">4.0</a> (2.0)</td>
        <td>10</td>
        <td>11.50</td>
        <td>5.0</td>
      </tr>
      <tr>
        <td>history.state</td>
        <td>18</td>
        <td><a href="http://Robing.github.io/en-US/Firefox/Releases/4" title="Released on 2011-03-22.">4.0</a> (2.0)</td>
        <td>10</td>
        <td>11.50</td>
        <td>6.0</td>
      </tr>
    </tbody>
  </table>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Web Notifications]]></title>
    <link href="http://Robing.github.io/blog/2014/06/03/using-web-notifications/"/>
    <updated>2014-06-03T16:46:58+08:00</updated>
    <id>http://Robing.github.io/blog/2014/06/03/using-web-notifications</id>
    <content type="html"><![CDATA[<div id="wiki-content" class="column-main wiki-column text-content">
    <!-- just the article content -->
    <article id="wikiArticle">
        <h2 id="Summary">Summary</h2>
        <p>The Web Notifications API allows a web page to send notifications that are displayed outside the page at the system level. This allows web apps to send information to a user even if the application is idle. One of the main obvious use cases is a webmail application that would notify the user each time a new e-mail is received, even if the user is doing something else with another application.</p>
        <p>To display notification you need to first request the appropriate permission and then instantiate a
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification" title="The Notification object is used to configure and display desktop notifications to the user.">Notification</a>object:
        </p>
        
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>            <span class="nx">Notification</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">status</span><span class="p">);</span> <span class="c1">// notifications will only be displayed if &quot;granted&quot;</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Notification</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">body</span><span class="o">:</span> <span class="s2">&quot;notification body&quot;</span><span class="p">});</span> <span class="c1">// this also shows the notification</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

        <h2 id="Requesting_permission">Requesting permission</h2>
        <h3 id="Web_content">Web content</h3>
        <p>Before an app is able to send a notification, the user must grant the application the right to do so. This is a common requirement when an API tries to interact with something outside a web page. This guarantees to avoid notification &#8220;spam&#8221; for the well-being of the user.</p>
        <p>An application that needs to send a notification can check the current permission status thanks to the
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.permission" title="The permission property indicates the current permission granted by the user about web notification for the current application.">Notification.permission</a>read only property. It can have one of three possible values:</p>
        <ul class="txtlist">
            <li>default: the user didn&#8217;t give any permission yet (and therefore no notification will be displayed to the user).</li>
            <li>granted: the user explicitly accepted to be notified by the application.</li>
            <li>denied: the user explicitly refused to be notified by the application.</li>
        </ul>
        <div class="note">
            <p><strong>Note:</strong>Chrome and Safari do not implement thepermissionproperty yet.</p>
        </div>
        <p>If the permission is not granted, the application has to use the<a href="http://Robing.github.io/en-US/docs/Web/API/Notification.requestPermission" title="The requestPermission static method is used to ask the user for his permission to display a Notification to him.">Notification.requestPermission()</a>method to let the user make a choice. This method accepts a callback function that receives the permission chosen by the user in order to react to it.</p>
        <p>It&#8217;s a common practice to ask for the permission at the initialization of the app:</p>
        
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>            <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">Notification</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// This allows to use Notification.permission with Chrome/Safari</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">!==</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">});</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

        <div class="note">
            <p>
                <strong>Note:</strong>Chrome does not allows to call
                <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.requestPermission" title="The requestPermission static method is used to ask the user for his permission to display a Notification to him.">Notification.requestPermission()</a>on theloadevent (see <a class="external external-icon" href="https://code.google.com/p/chromium/issues/detail?id=274284" title="https://code.google.com/p/chromium/issues/detail?id=274284">issue 274284</a>).
            </p>
        </div>
        <!-- more -->
        <h3 id="Installed_application">Installed application</h3>
        <p>When an application is installed, it&#8217;s possible to avoid to prompt the user for permission by adding the permission directly within the <a href="http://Robing.github.io/en-US/docs/Web/Apps/Manifest" title="/en-US/docs/Web/Apps/Manifest">application manifest</a>:</p>
        
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>           <span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>              <span class="s2">&quot;desktop-notification&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Allows to display notifications on the user&#39;s desktop.&quot;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

        <h2 id="Creating_a_notification">Creating a notification</h2>
        <p>Creating a notification is simply done using the
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification" title="The Notification object is used to configure and display desktop notifications to the user.">Notification</a>constructor. This constructor expects a title to display within the notification and some options to enhance the notification such as an
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.icon" title="The icon property indicates the URL of the icon to use with the notification.">icon</a>or a text
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.body" title="The body property represents the text content of the body of the notification.">body</a>.</p>
        <p>A notification is displayed as soon as possible when instantiated. To track the current state of a notification, four events are triggered at the
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification" title="The Notification object is used to configure and display desktop notifications to the user.">Notification</a>instance level:</p>
        <ul class="txtlist">
            <li><a href="http://Robing.github.io/en-US/docs/Web/Reference/Events/show" title="/en-US/docs/Web/Reference/Events/show">show</a>: triggered when the notification is displayed to the user.</li>
            <li><a href="http://Robing.github.io/en-US/docs/Web/Reference/Events/click" title="/en-US/docs/Web/Reference/Events/click">click</a></: triggered when the user clicks on the notification.</li>
            <li><a class="new" href="http://Robing.github.io/en-US/docs/Web/Reference/Events/close" title="/en-US/docs/Web/Reference/Events/close">close</a>: triggered when the notification is closed.</li>
            <li><a href="http://Robing.github.io/en-US/docs/Web/Reference/Events/error" title="/en-US/docs/Web/Reference/Events/error">error</a>: triggered when something wrong happens with the notification (mostly when something prevents the notification from being displayed)</li>
        </ul>
        <p>Those events can be tracked using the event handlers
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.onshow" title="Specifies an event listener to receive show events. These events occur when a Notification is displayed."><code>onshow</code></a>,
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.onclick" title="Specifies an event listener to receive click events. These events occur when the user clicks on a displayed Notification."><code>onclick</code></a>,
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.onclose" title="Specifies an event listener to receive close events. These events occur when a Notification is closed."><code>onclose</code></a>, or
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.onerror" title="Specifies an event listener to receive error events. These events occur when something goes wrong with a Notification (in many cases an error prevented the notification from being displayed)."><code>onerror</code></a>. Because
            <a href="http://Robing.github.io/en-US/docs/Web/API/Notification" title="The Notification object is used to configure and display desktop notifications to the user."><code>Notification</code></a>also inherits from
            <a href="http://Robing.github.io/en-US/docs/Web/API/EventTarget" title="EventTarget is a DOM interface implemented by objects that can receive DOM events and have listeners for them."><code>EventTarget</code></a>, it&#8217;s possible to use the
            <a href="http://Robing.github.io/en-US/docs/Web/API/EventTarget.addEventListener" title="The EventTarget.addEventListener() method registers the specified listener on the EventTarget it's called on. The event target may be an Element in a document, the Document itself, a Window, or any other object that supports events (such as XMLHttpRequest)."><code>addEventListener()</code></a>method.</p>
        <div class="note">
            <p>
                <strong>Note:</strong>Firefox and Safari close the notifications automatically after a few moments, e.g. 4&nbsp; seconds.</p>
            <p>This can also be done at the web application level using the
                <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.close" title="The close method is used to close a Notification that has been displayed."><code>Notification.close()</code></a>method, for example with the following code:</p>
                
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>                   <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Notification</span><span class="p">(</span><span class="s2">&quot;Hi!&quot;</span><span class="p">);</span>
</span><span class='line'>                    <span class="nx">n</span><span class="p">.</span><span class="nx">onshow</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                      <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">close</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

            <p>When you receive a &#8220;close&#8221; event, there is no guarantee that it&#8217;s the user who closed the notification. This is in line with the specification, which states: &#8220;When a notification is closed, either by the underlying notifications platform or by the user, the close steps for it must be run.&#8221;</p>
        </div>
        <h3 id="Simple_example">Simple example</h3>
        <p>Assume the following basic HTML:</p>
        
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>           <span class="o">&lt;</span><span class="nx">button</span><span class="o">&gt;</span><span class="nx">Notify</span> <span class="nx">me</span><span class="o">!&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

        <p>It&#8217;s possible to handle notifications this way:</p>
        
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>           <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>              <span class="c1">// At first, let&#39;s check if we have permission for notification</span>
</span><span class='line'>              <span class="c1">// If not, let&#39;s ask for it</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span> <span class="o">&amp;&amp;</span> <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">!==</span> <span class="s2">&quot;granted&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">Notification</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">!==</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>              <span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// If the user agreed to get notified</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span> <span class="o">&amp;&amp;</span> <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">===</span> <span class="s2">&quot;granted&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Notification</span><span class="p">(</span><span class="s2">&quot;Hi!&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// If the user hasn&#39;t told if he wants to be notified or not</span>
</span><span class='line'>                <span class="c1">// Note: because of Chrome, we are not sure the permission property</span>
</span><span class='line'>                <span class="c1">// is set, therefore it&#39;s unsafe to check for the &quot;default&quot; value.</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span> <span class="o">&amp;&amp;</span> <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">!==</span> <span class="s2">&quot;denied&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="nx">Notification</span><span class="p">.</span><span class="nx">requestPermission</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">!==</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="nx">Notification</span><span class="p">.</span><span class="nx">permission</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">// If the user said okay</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="s2">&quot;granted&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Notification</span><span class="p">(</span><span class="s2">&quot;Hi!&quot;</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">// Otherwise, we can fallback to a regular modal alert</span>
</span><span class='line'>                    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                      <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hi!&quot;</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                  <span class="p">});</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// If the user refuses to get notified</span>
</span><span class='line'>                <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="c1">// We can fallback to a regular modal alert</span>
</span><span class='line'>                  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Hi!&quot;</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>              <span class="p">});</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

        <p>And the live result:</p>
        <p>
            <iframe class="live-sample-frame" frameborder="0" height="30" src="https://mdn.mozillademos.org/en-US/docs/WebAPI/Using_Web_Notifications$samples/Tag_example?revision=561527" width="100%"></iframe>
        </p>

        <h3 id="Gecko_notes">Gecko notes</h3>
        <ul class="txtlist">
            <li>Prior to Firefox 22 (Firefox OS &lt;1.2), the instantiation of a new notification must be done with the
                <a href="http://Robing.github.io/en-US/docs/Web/API/window.navigator.mozNotification" title="Provides support for creating notification objects, which are used to display desktop notification alerts to the user. Currently, these are only supported on Firefox Mobile and Firefox OS. See Displaying notifications for an example."><code>navigator.mozNotification</code></a>object through its<code>createNotification</code>method.</li>
            <li>Prior to Firefox 22 (Firefox OS &lt;1.2), the Notification was displayed when calling the<code>show</code>method and was supporting the<code>click</code>and<code>close</code>events only.</li>
            <li>Nick Desaulniers has written a <a class="external external-icon" href="https://github.com/nickdesaulniers/fxos-irc/blob/master/js/notification.js">Notification shim</a> to cover both newer and older implementations.</li>
            <li>One particular Firefox OS issue is that you can <a class="external external-icon" href="https://github.com/nickdesaulniers/fxos-irc/blob/0160cf6c3a2b5c9fe33822aaf6bcba3b7e846da9/my.js#L171">pass a path to an icon</a> to use in the notification, but if the app is packaged you cannot use a relative path like<code>/my_icon.png</code>. You also can&#8217;t use<code>window.location.origin + "/my_icon.png"</code>because<code>window.location.origin</code>is null in packaged apps. The <a href="https://developer.mozilla.org/en-US/Apps/Developing/Manifest#origin">manifest origin field</a> fixes this, but it is only available in Firefox OS 1.1+. A potential solution for supporting Firefox OS &lt;1.1 is to <a class="external external-icon" href="https://github.com/nickdesaulniers/fxos-irc/blob/0160cf6c3a2b5c9fe33822aaf6bcba3b7e846da9/my.js#L168">pass an absolute URL to an externally hosted version of the icon</a>. This is less than ideal as the notification is displayed immediately with the icon missing, then the icon is fetched, but it works on all versions of Firefox OS.</li>
        </ul>
        <h3 id="Chrome_notes">Chrome notes</h3>
       <ul class="txtlist">
            <li>Prior to Chrome 22, the support for notification was following an <a class="external external-icon" href="http://www.chromium.org/developers/design-documents/desktop-notifications/api-specification" title="http://www.chromium.org/developers/design-documents/desktop-notifications/api-specification">old prefixed version of the specification</a> and was using the
                <a class="new" href="http://Robing.github.io/en-US/docs/Web/API/window.navigator.webkitNotifications" title="The documentation about this has not yet been written; please consider contributing!"><code>navigator.webkitNotifications</code></a>object to instantiate a new notification.</li>
            <li>Prior to Chrome 32,
                <a href="http://Robing.github.io/en-US/docs/Web/API/Notification.permission" title="The permission property indicates the current permission granted by the user about web notification for the current application."><code>Notification.permission</code></a>was not supported.</li>
        </ul>
        <h3 id="Safari_notes">Safari notes</h3>
        <ul class="txtlist">
            <li>Safari started supporting notification with Safari 6 but only on Mac OSX 10.8+ (Mountain Lion).</li>
        </ul>
        <table class="table">
          <tbody>
           <tr>
            <th>Feature</th>
            <th>Chrome</th>
            <th>Firefox (Gecko)</th>
            <th>Internet Explorer</th>
            <th>Opera</th>
            <th>Safari</th>
           </tr>
           <tr>
            <td>Basic support</td>
            <td>5 <span title="prefix" class="inlineIndicator prefixBox prefixBoxInline">webkit</span> (see notes)<br>
             22</td>
            <td>4.0 <span title="prefix" class="inlineIndicator prefixBox prefixBoxInline">moz</span> (see notes)<br>
             22</td>
            <td><span style="color: #f00;">Not&nbsp;supported</span></td>
            <td><span title="Compatibility unknown; please update this." style="color: rgb(255, 153, 0);">?</span></td>
            <td>6 (see notes)</td>
           </tr>
          </tbody>
         </table>
    </article>

    <!-- attachments list -->
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shadow DOM 三]]></title>
    <link href="http://Robing.github.io/blog/2014/05/16/shadow-dom-301/"/>
    <updated>2014-05-16T12:21:36+08:00</updated>
    <id>http://Robing.github.io/blog/2014/05/16/shadow-dom-301</id>
    <content type="html"><![CDATA[<div class="content" id="article-content">
<p>This article discusses more of the amazing things you can do with Shadow DOM! It builds on the concepts discussed in <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom/">Shadow DOM 101</a>
and <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom-201/">Shadow DOM 201</a>.</p>
<p class="tip notice">In Chrome, turn on the &#8220;Enable experimental Web Platform features&#8221; in about:flags to experiment with everything covered in this article.</p>

<h2 id="toc-shadow-multiple">Using multiple shadow roots</h2>

<p>If you&#8217;re hosting a party, it gets stuffy if everyone is crammed into the same room.
You want the option of distributing groups of people across multiple rooms. Elements hosting
Shadow DOM can do this too, that is to say, they can host more than one shadow
root at a time.</p>
<p>Let&#8217;s see what happens if we try to attach multiple shadow roots to a host:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>     <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;example1&quot;</span><span class="nt">&gt;</span>Light DOM<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;script&gt;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#example1&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">root1</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">root2</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">root1</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;div&gt;Root 1 FTW&lt;/div&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">root2</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;div&gt;Root 2 FTW&lt;/div&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<div class="demodevtools"> 
<img src="http://rainer.qiniudn.com/stacking.png" title="Attaching multiple shadow trees" alt="Attaching multiple shadow trees" style="width:250px;">
</div>

<div class="demoarea">
  <div id="example1">Light DOM</div>
</div>

<script>
(function() {
var container = document.querySelector('#example1');
var root1 = container.createShadowRoot();
var root2 = container.createShadowRoot();
root1.innerHTML = '<div>Root 1 FTW</div>';
root2.innerHTML = '<div>Root 2 FTW</div>';
})();
</script>

<p class="notice tip">In the DevTools, turn on &#8220;Show Shadow DOM&#8221; to be
  able to inspect ShadowRoots.</p>

<p>What renders is &#8220;Root 2 FTW&#8221;, despite the fact that we had already attached a shadow tree.
This is because the last shadow tree added to a host, wins. It&#8217;s a LIFO stack as
far as rendering is concerned. Examining the DevTools verifies this behavior.</p>
<p class="notice fact">Shadow trees added to a host are stacked in the order they&#8217;re added,
starting with the most recent first. The last one added is the one that renders.</p>

<blockquote class="commentary talkinghead" id="youngest-tree">
The most recently added tree is called the <b>younger tree</b>. Previous trees are called <b>older trees</b>. In this example, <code>root2</code> is the younger tree and  <code>root1</code> is the older tree.
</blockquote>

<p>So what&#8217;s the point of using multiple shadows if only the last is invited to the
rendering party? Enter shadow insertion points.</p>
<h3 id="toc-shadow-insertion">Shadow Insertion Points</h3>

<!-- more -->

<p>&#8220;Shadow insertion points&#8221; (<code>&lt;shadow&gt;</code>) are similar to normal <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom/#toc-separation-separate">insertion points</a> (<code>&lt;content&gt;</code>) in that they&#8217;re placeholders. However, instead of being placeholders for a host&#8217;s <em>content</em>, they&#8217;re hosts for other <em>shadow trees</em>.
It&#8217;s Shadow DOM Inception!</p>
<p>As you can probably imagine, things get more complicated the further you drill down
the rabbit hole. For this reason, the spec is very clear about what happens when
multiple <code>&lt;shadow&gt;</code> elements are in play:</p>
<p class="notice fact">If multiple <code>&lt;shadow&gt;</code> insertion points exist
in a shadow tree, only the first is recognized. The rest are ignored.</p>

<p>Looking back to our original example, the first shadow <code>root1</code> got left off the
invite list. Adding a <code>&lt;shadow&gt;</code> insertion point brings it back:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;example2&quot;</span><span class="nt">&gt;</span>Light DOM<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#example2&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">root1</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">root2</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">root1</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;div&gt;Root 1 FTW&lt;/div&gt;&lt;content&gt;&lt;/content&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">root2</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;div&gt;Root 2 FTW&lt;/div&gt;&lt;shadow&gt;&lt;/shadow&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<div class="demodevtools"> 
<img src="http://rainer.qiniudn.com/shadow-insertion-point.png" title="Shadow insertion points" alt="Shadow insertion points" style="width:250px;">
</div>

<div class="demoarea">
  <div id="example2">Light DOM</div>
</div>

<script>
(function() {
var container = document.querySelector('#example2');
var root1 = container.createShadowRoot();
var root2 = container.createShadowRoot();
root1.innerHTML = '<div>Root 1 FTW</div><content></content>';
root2.innerHTML = '<div>Root 2 FTW</div><shadow></shadow>';
})();
</script>

<p>There are a couple of interesting things about this example:</p>
<ol>
<li>&#8220;Root 2 FTW&#8221; still renders above &#8220;Root 1 FTW&#8221;. This is because of where we&#8217;ve placed
the <code>&lt;shadow&gt;</code> insertion point. If you want the reverse, move the insertion point: <code>root2.innerHTML = '&lt;shadow&gt;&lt;/shadow&gt;&lt;div&gt;Root 2 FTW&lt;/div&gt;';</code>.</li>
<li>Notice there&#8217;s now a <code>&lt;content&gt;</code> insertion point in root1. This makes
the text node &#8220;Light DOM&#8221; come along for the rendering ride.</li>
</ol>
<p><b id="toc-shadow-older">What&#8217;s rendered at &lt;shadow&gt;?</b></p>
<p>Sometimes it&#8217;s useful to know the older shadow tree being rendered at a <code>&lt;shadow&gt;</code>. You can get a reference to that tree through <code>.olderShadowRoot</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>   <span class="nx">root2</span><span class="p">.</span><span class="nx">olderShadowRoot</span> <span class="o">===</span> <span class="nx">root1</span> <span class="c1">//true</span>
</span></code></pre></td></tr></table></div></figure>


<h2 id="toc-get-shadowroot">Obtaining a host&#8217;s shadow root</h2>

<p>If an element is hosting Shadow DOM you can access its <a href="#youngest-tree">youngest shadow root</a>
using <code>.shadowRoot</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>   <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">shadowRoot</span> <span class="o">===</span> <span class="nx">root</span><span class="p">);</span> <span class="c1">// true</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">shadowRoot</span><span class="p">);</span> <span class="c1">// null</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;re worried about people crossing into your shadows, redefine
 <code>.shadowRoot</code> to be null:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>   <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="s1">&#39;shadowRoot&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>A bit of a hack, but it works. In the end, it&#8217;s important to remember that while amazingly fantastic,
<strong>Shadow DOM has not been designed to be a security feature</strong>. Don&#8217;t rely on it for
complete content isolation.</p>
<h2 id="toc-creating-js">Building Shadow DOM in JS</h2>

<p>If you prefer building DOM in JS, <code>HTMLContentElement</code> and <code>HTMLShadowElement</code>
have interfaces for that.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;example3&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;span&gt;</span>Light DOM<span class="nt">&lt;/span&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#example3&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">root1</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">root2</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">div</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s1">&#39;Root 1 FTW&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">root1</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// HTMLContentElement</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">content</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="s1">&#39;span&#39;</span><span class="p">;</span> <span class="c1">// selects any spans the host node contains</span>
</span><span class='line'>  <span class="nx">root1</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">div</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s1">&#39;Root 2 FTW&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">root2</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// HTMLShadowElement</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">shadow</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;shadow&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">root2</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">shadow</span><span class="p">);</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This example is nearly identical to the one in the <a href="#toc-shadow-insertion">previous section</a>.
The only difference is that now I&#8217;m using <code>select</code> to pull out the newly added <code>&lt;span&gt;</code>.</p>
<h2 id="toc-distributed-nodes">Working with insertion points</h2>

<p>Nodes that are selected out of the host element and &#8220;distribute&#8221; into the shadow tree
are called&#8230;drumroll&#8230;distributed nodes! They&#8217;re allowed to cross the shadow boundary
when insertion points invite them in.</p>
<p>What&#8217;s conceptually bizarre about insertion points is that they don&#8217;t physically
move DOM. The host&#8217;s nodes stay intact. Insertion points merely re-project nodes
from the host into the shadow tree. It&#8217;s a presentation/rendering thing: <s>&#8220;Move these nodes over here&#8221;</s> &#8220;Render these nodes at this location.&#8221;</p>
<p class="notice fact">You cannot traverse the DOM into a <code>&lt;content&gt;</code>.</p>

<p>For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;div&gt;&lt;h2&gt;</span>Light DOM<span class="nt">&lt;/h2&gt;&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;content select=&quot;h2&quot;&gt;&lt;/content&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">h2</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;h2&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;content[select=&quot;h2&quot;] h2&#39;</span><span class="p">));</span> <span class="c1">// null;</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">).</span><span class="nx">contains</span><span class="p">(</span><span class="nx">h2</span><span class="p">));</span> <span class="c1">// false</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Voilà! The <code>h2</code> isn&#8217;t a child of the shadow DOM. This leads to another tid bit:</p>
<blockquote class="commentary talkinghead">
Insertion points are incredibly powerful. Think of them as a way to create a
&#8220;declarative API&#8221; for your Shadow DOM. A host element can include all the markup in the world,
but unless I invite it into my Shadow DOM with an insertion point, it&#8217;s meaningless.
</blockquote>

<h3 id="toc-getDistributedNodes">Element.getDistributedNodes()</h3>

<p>We can&#8217;t traverse into a <code>&lt;content&gt;</code>, but the <code>.getDistributedNodes()</code> API
allows us to query the distributed nodes at an insertion point:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;example4&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h2&gt;</span>Eric<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h2&gt;</span>Bidelman<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div&gt;</span>Digital Jedi<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h4&gt;</span>footer text<span class="nt">&lt;/h4&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;template</span> <span class="na">id=</span><span class="s">&quot;sdom&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;header&gt;</span>
</span><span class='line'>      <span class="nt">&lt;content</span> <span class="na">select=</span><span class="s">&quot;h2&quot;</span><span class="nt">&gt;&lt;/content&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/header&gt;</span>
</span><span class='line'>    <span class="nt">&lt;section&gt;</span>
</span><span class='line'>      <span class="nt">&lt;content</span> <span class="na">select=</span><span class="s">&quot;div&quot;</span><span class="nt">&gt;&lt;/content&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/section&gt;</span>
</span><span class='line'>    <span class="nt">&lt;footer&gt;</span>
</span><span class='line'>      <span class="nt">&lt;content</span> <span class="na">select=</span><span class="s">&quot;h4:first-of-type&quot;</span><span class="nt">&gt;&lt;/content&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/footer&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/template&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#example4&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#sdom&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">clone</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">importNode</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">root</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">clone</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="p">[].</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">outerHTML</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">getDistributedNodes</span><span class="p">();</span>
</span><span class='line'>    <span class="p">[].</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">nodes</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">outerHTML</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">html</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<div id="example4" style="display:none">
  <h2>Eric</h2>
  <h2>Bidelman</h2>
  <div>Digital Jedi</div>
  <h4>footer text</h4>
</div>

<p><template id="sdom">
  <header>
    <content select="h2"></content>
  </header>
  <section>
    <content select="div"></content>
  </section>
  <footer>
    <content select="h4:first-of-type"></content>
  </footer>
</template></p>
<div id="example4-log" class="demoarea none">
 <textarea readonly=""></textarea>
</div>

<script>
(function() {
if ('HTMLTemplateElement' in window) {
  var container = document.querySelector('#example4');

  var root1 = container.createShadowRoot();
  var t = document.querySelector('#sdom');
  var clone = document.importNode(t.content, true);
  root1.appendChild(clone);

  var html = [];
  [].forEach.call(root1.querySelectorAll('content'), function(el) {
    html.push(el.outerHTML + ': ');
    var nodes = el.getDistributedNodes();
    [].forEach.call(nodes, function(node) {
      html.push(node.outerHTML);
    });
    html.push('\n');
  });

  document.querySelector('#example4-log textarea').value = html.join('');
}
})();
</script>

<h3 id="toc-getDestinationInsertionPoints">Element.getDestinationInsertionPoints()</h3>

<p>Similar to <code>.getDistributedNodes()</code>, you can check what insertion points
a node is distributed into by calling its <code>.getDestinationInsertionPoints()</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;host&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h2&gt;</span>Light DOM<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">root1</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">root2</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">root1</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;content select=&quot;h2&quot;&gt;&lt;/content&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">root2</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;shadow&gt;&lt;/shadow&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">h2</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#host h2&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">insertionPoints</span> <span class="o">=</span> <span class="nx">h2</span><span class="p">.</span><span class="nx">getDestinationInsertionPoints</span><span class="p">();</span>
</span><span class='line'>    <span class="p">[].</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">insertionPoints</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">contentEl</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contentEl</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<div id="example5-gip" style="display:none">
  <h2>Light DOM</h2>
</div>

<div id="example5-getDestInsertinoPoints" class="demoarea none">
 <textarea readonly=""></textarea>
</div>

<script>
(function() {
if (!!Element.prototype.getDestinationInsertionPoints) { 
  var container = document.querySelector('#example5-gip');
  var h2 = container.querySelector('h2');

  var root1 = container.createShadowRoot();
  var root2 = container.createShadowRoot();
  root1.innerHTML = '<content select="h2"></content>';
  root2.innerHTML = '<shadow></shadow>';

  var html = [];
  var insertionPoints = h2.getDestinationInsertionPoints();
  [].forEach.call(insertionPoints, function(contentEl) {
    html.push(contentEl.outerHTML);
    html.push('\n');
  });

  document.querySelector('#example5-getDestInsertinoPoints textarea').value = html.join('');
}
})();
</script>

<h2 id="toc-shadow-visualizder">Tool: Shadow DOM Visualizer</h2>

<p>Understanding the black magic that is Shadow DOM is difficult. I remember trying
to wrap my head around it for the first time.</p>
<p>To help visualize how Shadow DOM rendering works, I&#8217;ve built a tool
using <a href="http://d3js.org/">d3.js</a>. Both markup boxes on the left-hand side are
editable. Feel free to paste in your own markup and play around to see how things
work and insertion points swizzle host nodes into the shadow tree.</p>
<figure>
<a href="http://html5-demos.appspot.com/static/shadowdom-visualizer/index.html"><img src="http://rainer.qiniudn.com/visualizer.png" title="Shadow DOM Visualizer" alt="Shadow DOM Visualizer"></a>
<figcaption><a href="http://html5-demos.appspot.com/static/shadowdom-visualizer/index.html">Launch Shadow DOM Visualizer</a></figcaption>
</figure>

<p>
<iframe width="420" height="315" src="http://www.youtube.com/embed/qnJ_s58ubxg" frameborder="0" allowfullscreen=""></iframe>
</p>

<p>Give it a try and let me know what you think!</p>
<h2 id="toc-events">Event Model</h2>

<p>Some events cross the shadow boundary and some do not. In the cases where events
cross the boundary, the event target is adjusted in order to maintain the
encapsulation that the shadow root&#8217;s upper boundary provides. That is, <strong>events
are retargeted to look like they&#8217;ve come from the host element rather than internal
elements to the Shadow DOM</strong>.</p>
<p class="tip notice">Access <code>event.path</code> to see the adjusted event path.</p>

<p>If your browser supports Shadow DOM (it does<span class="featuresupported no">n&#8217;t</span>),
you should see a play area below that helps visualize events. Elements in <span style="color:#ffcc00">yellow</span> are part of the Shadow DOM&#8217;s markup. Elements in <span style="color:steelblue">blue</span> are
part of the host element. The <span style="color:#ffcc00">yellow</span> border
around &#8220;I&#8217;m a node in the host&#8221; signifies that it is a distributed node, passing
through the shadow&#8217;s <code>&lt;content&gt;</code> insertion point.</p>
<p>The &#8220;Play Action&#8221; buttons show you different things to try. Give them a go to see
how the <code>mouseout</code> and <code>focusin</code> events bubble up to the main page.</p>
<div id="example5" class="demoarea none">
  <div data-host="">
    <div class="blue">I&#8217;m a node in the host</div>
  </div>

  <template style="display:none;"> <!-- display:none used for older browsers -->
    <style>
    .scopestyleforolderbrowsers * {
      border: 4px solid #FC0;
    }
    .scopestyleforolderbrowsers input {
      padding: 5px;
    }
    .scopestyleforolderbrowsers div {
      background: #FC0;
      padding: 5px;
      border-radius: 3px;
      margin: 5px 0;
    }
    content::-webkit-distributed(*) {
      border: 4px solid #FC0;
    }
    ::content * {
      border: 4px solid #FC0;
    }
    </style>
    <section class="scopestyleforolderbrowsers">
      <div>I&#8217;m a node in Shadow DOM</div>
      <div>I&#8217;m a node in Shadow DOM</div>
      <content></content>
      <input type="text" placeholder="I'm in Shadow DOM">
      <div>I&#8217;m a node in Shadow DOM</div>
      <div>I&#8217;m a node in Shadow DOM</div>
    </section>
  </template>

  <aside class="cursor"></aside>

  <div class="buttons">
    <button data-action="playAnimation" data-action-idx="1">Play Action 1</button><br>
    <button data-action="playAnimation" data-action-idx="2">Play Action 2</button><br>
    <button data-action="playAnimation" data-action-idx="3">Play Action 3</button><br>
    <button data-action="clearLog">Clear log</button>
  </div>

  <output></output>
</div>

<script>
(function() {
function stringify(node) {
  return node.outerHTML.match(".*?>")[0].replace('<', '&lt;').replace('>', '&gt;');
}

var out = document.querySelector('#example5 output');
var host = document.querySelector('#example5 [data-host]');
var wrapper = document.querySelector('#example5');

var root = host.createShadowRoot();
root.innerHTML = document.querySelector('#example5 template').innerHTML;

host.addEventListener('mouseout', function(e) {

  out.innerHTML += [
    '<span>[' + e.type + ']</span>', 
    'on:', stringify(e.target) + ',', 
    'from', stringify(e.fromElement),
    '&rarr;', stringify(e.toElement), '<br>'].join(' ');
  out.scrollTop = out.scrollHeight;
});

document.addEventListener('focusin', function(e) {
  out.innerHTML += [
    '<span>[' + e.type + ']</span>',
    'on:', stringify(e.target), '<br>'].join(' ');
  out.scrollTop = out.scrollHeight;
});

function clearLog() {
  out.innerHTML = '';
}

function cleanUpAnimations(node) {
  [].forEach.call(node.classList, function(c) {
    if (c.indexOf('animation') == 0) {
      node.classList.remove(c);
    }
  });
}

function playAnimation(idx) {
  clearLog();
  wrapper.classList.add('playing');
  wrapper.classList.add('animation' + idx);
}

wrapper.addEventListener('webkitAnimationEnd', function(e) {
  this.classList.remove('playing');
  cleanUpAnimations(this);
});

wrapper.addEventListener('animationend', function(e) {
  this.classList.remove('playing');
  cleanUpAnimations(this);
});

document.querySelector('#example5 .buttons').addEventListener('click', function(e) {
  if (e.target.tagName == 'BUTTON') {
    switch(e.target.dataset.action) {
      case 'clearLog':
        clearLog();
        break;
      case 'playAnimation':
        cleanUpAnimations(wrapper);
        playAnimation(parseInt(e.target.dataset.actionIdx));
        break;
      default:
        break;
    }
  }
});

})();
</script>

<p><strong>Play Action 1</strong></p>
<ul>
    <li>This one is interesting. You should see a <code>mouseout</code> from the host element (<code>&lt;div data-host&gt;</code>)
    to the <span style="color:steelblue">blue</span> node. Even though it&#8217;s a distributed
    node, it&#8217;s still in the host, not the ShadowDOM. Mousing further down into 
    <span style="color:#ffcc00">yellow</span> again causes a <code>mouseout</code> on the <span style="color:steelblue">blue</span> node.</li>
</ul>
<p><strong>Play Action 2</strong></p>
<ul>
    <li>There is one <code>mouseout</code> that appears on host (at the very end). Normally you&#8217;d
    see <code>mouseout</code> events trigger for all of the <span style="color:#ffcc00">yellow</span> blocks.
    However, in this case these elements are internal to the Shadow DOM and the event
    doesn&#8217;t bubble through its upper boundary.</li>
</ul>
<p><strong>Play Action 3</strong></p>
<ul>
    <li>Notice that when you click the input, the <code>focusin</code> doesn&#8217;t appear on the
    input but on the host node itself. It&#8217;s been retargeted!</li>
</ul>
<h3 id="toc-events-stopped">Events that are always stopped</h3>

<p>The following events never cross the shadow boundary:</p>
<ul>
<li>abort</li>
<li>error</li>
<li>select</li>
<li>change</li>
<li>load</li>
<li>reset</li>
<li>resize</li>
<li>scroll</li>
<li>selectstart</li>
</ul>
<h2 id="toc-conclusion">Conclusion</h2>

<p>I hope you&#8217;ll agree that <strong>Shadow DOM is incredibly powerful</strong>. For the first time ever, we have proper encapsulation without the extra baggage of <code>&lt;iframe&gt;</code>s or other older techniques. </p>
<p>Shadow DOM is certainly complex beast, but it&#8217;s a beast worth adding to the web platform.
Spend some time with it. Learn it. Ask questions.</p>
<p>If you want to learn more, see Dominic&#8217;s intro article <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom/">Shadow DOM 101</a>
and my <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom-201/">Shadow DOM 201: CSS &amp; Styling</a> article.</p>
<p class="small-notice">
Thanks to <a href="http://Robing.github.io/profiles/#dominiccooney">Dominic Cooney</a> and 
<a href="https://plus.google.com/111648463906387632236/posts">Dimitri Glazkov</a> for reviewing
the content of this tutorial.
</p><script>
document.addEventListener('DOMContentLoaded', function(e) {
  if (!isCompatible()) {
    document.body.classList.add('disabledemos');
    $('.featuresupported').removeClass('no');
  }
});
</script>

</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shadow DOM 二]]></title>
    <link href="http://Robing.github.io/blog/2014/05/16/shadow-dom-201/"/>
    <updated>2014-05-16T12:16:18+08:00</updated>
    <id>http://Robing.github.io/blog/2014/05/16/shadow-dom-201</id>
    <content type="html"><![CDATA[<div class="content" id="article-content">
    <p>This article discusses more of the amazing things you can do with Shadow DOM. It builds on the concepts discussed in <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom/">Shadow DOM 101</a>. If you&#8217;re looking for an introduction, see that article.</p>
    <h2 id="toc-intro">Introduction</h2>
    <p>Let&#8217;s face it. There&#8217;s nothing sexy about unstyled markup. Lucky for us, <a href="http://w3c.github.io/webcomponents/explainer/#acknowledgements">the brilliant folks behind Web Components</a>
        foresaw this and didn&#8217;t leave us hanging. The <a href="http://dev.w3.org/csswg/css-scoping/">CSS Scoping Module</a> defines many options for styling content in a shadow tree.</p>
    <p class="tip notice">In Chrome, turn on the &#8220;Enable experimental Web Platform features&#8221; in about:flags to experiment with everything covered in this article.</p>
    <h2 id="toc-style-scoped">Style encapsulation</h2>
    <p>One of the core features of Shadow DOM is the <a href="http://w3c.github.io/webcomponents/spec/shadow/#shadow-trees">shadow boundary</a>. It has a lot of nice properties, but one of the best is that it provides style encapsulation for free. Stated another way:</p>
    <p class="notice fact">CSS styles defined inside Shadow DOM are scoped to the ShadowRoot. This means styles are encapsulated by default.</p>
    <p>Below is an example. If all goes well and your browser supports Shadow DOM (it does
        <span class="featuresupported no">n&#8217;t</span>!), you&#8217;ll see &#8221;
        <span style="color:red">Shadow DOM</span>&#8221;.</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>        <span class="nt">&lt;div&gt;&lt;h3&gt;</span>Light DOM<span class="nt">&lt;/h3&gt;&lt;/div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script&gt;</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>            <span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;style&gt;h3{ color: red; }&lt;/style&gt;&#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;h3&gt;Shadow DOM&lt;/h3&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <div class="demoarea none">
        <div id="style-ex-scoped">
            <h3>Light DOM</h3>
        </div>
    </div>

    <script>
    (function() {
        var container = document.querySelector('#style-ex-scoped');
        var root = container.createShadowRoot();
        root.innerHTML = '<style>h3{color: red;}</style><h3>Shadow DOM</h3>';
    })();
    </script>

    <p>There are two interesting observations about this demo:</p>
    <ul>
        <li>There are
            <a onclick=alertMsg() href="#">other h3s on this page</a>, but the only one that matches the h3 selector, and therefore styled red, is the one in the ShadowRoot. Again, scoped styles by default.</li>
        <li>Other styles rules defined on this page that target h3s don&#8217;t bleed into my content. That&#8217;s because
            <strong>selectors don&#8217;t cross the shadow boundary</strong>.</li>
    </ul>
    <script type="text/javascript">
    var alertMsg = function(msg){
        if(msg){
            alert(msg)
        }else{
            len = document.querySelectorAll('h3').length;
            msg = 'There are ' + len + ' <h3> on this page.';
            alert(msg);
        }
        return false;
    }
    </script>
    <p>Moral of the story? We have style encapsulation from the outside world. Thanks Shadow DOM!</p>
    <!-- more -->
    <h2 id="toc-style-host">Styling the host element</h2>

    <p>The
        <code>:host</code>allows you to select and style the element hosting a shadow tree:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;red&quot;</span><span class="nt">&gt;</span>My Button<span class="nt">&lt;/button&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script&gt;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">button</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;style&gt;&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;:host { text-transform: uppercase; }&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;&lt;/style&gt;&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;&lt;content&gt;&lt;/content&gt;&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <div class="demoarea none">
        <button id="style-athost" class="red">My Button</button>
    </div>

    <script>
    (function() {
        var container = document.querySelector('#style-athost');
        var root = container.createShadowRoot();
        root.innerHTML = '<style>' +
            ':host { text-transform: uppercase; }' +
            '</style>' +
            '<content></content>';
    })();
    </script>

    <p>One gotcha is that rules in the parent page have higher specificity than
        <code>:host</code>
        rules defined in the element, but lower specificity than a
        <code>style</code>attribute defined on the host element. This allows users to override your styling from the outside.
        <code>:host</code>also only works in the context of a ShadowRoot so you can&#8217;t use it outside of Shadow DOM.</p>
    <p>The functional form of
        <code>:host(&lt;selector&gt;)</code>allows you to target the host element if it matches a
        <code>&lt;selector&gt;</code>.</p>
    <p>
        <strong>Example</strong>- match only if the element itself has the class
        <code>.different</code>(e.g..
        <code>&lt;x-foo class="different"&gt;&lt;/x-foo&gt;</code>):</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nd">:host</span><span class="o">(</span><span class="nc">.different</span><span class="o">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <h3 id="toc-style-states">Reacting to user states</h3>

    <p>A common use case for
        <code>:host</code>is when you&#8217;re creating a <a href="http://Robing.github.io/tutorials/webcomponents/customelements/">Custom Element</a> and want to react to different user states (:hover, :focus, :active, etc.).</p>
            
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>                <span class="nt">&lt;style&gt;</span>
</span><span class='line'>        <span class="nd">:host</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="o">.</span><span class="m">4</span><span class="p">;</span>
</span><span class='line'>          <span class="n">transition</span><span class="o">:</span> <span class="k">opacity</span> <span class="m">420</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">out</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nd">:host</span><span class="o">(</span><span class="nd">:hover</span><span class="o">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">opacity</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nd">:host</span><span class="o">(</span><span class="nd">:active</span><span class="o">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
</span><span class='line'>          <span class="k">top</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>          <span class="k">left</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="nt">&lt;/style&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <div class="demoarea none">
        <button id="style-athost-ex2">My Button</button>
    </div>

    <script>
    (function() {
        var container = document.querySelector('#style-athost-ex2');
        var root = container.createShadowRoot();
        root.innerHTML = '<style>\
      :host {\
        opacity: 0.4;\
        transition: opacity 200ms ease-in-out;\
      }\
      :host(:active) { position:relative;top:3px;left:3px; }\
      :host(:hover) {\
        opacity: 1;\
      }\
    }</style><content></content>';
    })();
    </script>

    <h3 id="toc-style-themeing">Theming an element</h3>

    <p>The
        <code>:host-context(&lt;selector&gt;)</code>pseudo class matches the host element if it or any of its ancestors matches
        <code>&lt;selector&gt;</code>.</p>
    <p>A common use of
        <code>:host-context()</code>is for theming an element based on its surrounds. For example, many people do theming by applying a class to
        <code>&lt;html&gt;</code>or
        <code>&lt;body&gt;</code>:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>        <span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">&quot;different&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;x</span><span class="na">-foo</span><span class="nt">&gt;</span><span class="err">&lt;</span>/x-foo&gt;
</span><span class='line'>        <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <p>You can
        <code>:host-context(.different)</code>to style
        <code>&lt;x-foo&gt;</code>when it&#8217;s a descendant of an element with the class
        <code>.different</code>:</p>
   
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nd">:host-context</span><span class="o">(</span><span class="nc">.different</span><span class="o">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <p>This gives you the ability encapsulate style rules in an element&#8217;s Shadow DOM that uniquely style it, based on its context.</p>
    <h3 id="toc-style-multi">Support multiple host types from within one shadow root</h3>

    <p>Another use for
        <code>:host</code>is if you&#8217;re creating a theming library and want to support styling many types of host elements from within the same Shadow DOM.</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nd">:host</span><span class="o">(</span><span class="nt">x-foo</span><span class="o">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="c">/* Applies if the host is a &lt;x-foo&gt; element.*/</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">:host</span><span class="o">(</span><span class="nt">x-foo</span><span class="nd">:host</span><span class="o">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="c">/* Same as above. Applies if the host is a &lt;x-foo&gt; element. */</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nd">:host</span><span class="o">(</span><span class="nt">div</span><span class="o">)</span> <span class="p">{</span>  <span class="err">{</span>
</span><span class='line'>              <span class="c">/* Applies if the host element is a &lt;div&gt;. */</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="err">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <h2 id="toc-style-cat-hat">Styling Shadow DOM internals from the outside</h2>

    <p>The
        <code>::shadow</code>pseudo-element and
        <code>/deep/</code>combinator are like having a Vorpal sword of CSS authority. They allow piercing through Shadow DOM&#8217;s boundary to style elements within shadow trees.</p>
    <h3 id="toc-style-hat">The ::shadow pseudo-element</h3>

    <p>If an element has at least one shadow tree, the
        <code>::shadow</code>pseudo-element matches the shadow root itself. It allows you to write selectors that style nodes internal to an element&#8217;s shadow dom.</p>
    <p>For example, if an element is hosting a shadow root, you can write
        <code>#host::shadow span {}</code>to style all of the spans within its shadow tree.</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>        <span class="nt">&lt;style&gt;</span>
</span><span class='line'>          <span class="nf">#host</span><span class="o">:</span><span class="nd">:shadow</span> <span class="nt">span</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;host&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;span&gt;</span>Light DOM<span class="nt">&lt;/span&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;script&gt;</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">host</span><span class="p">.</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;span&gt;Shadow DOM&lt;/span&gt;&quot;</span> <span class="o">+</span>
</span><span class='line'>                           <span class="s2">&quot;&lt;content&gt;&lt;/content&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <div class="demoarea none">
        <div id="style-hat-ex">
            <span>Light DOM</span>
        </div>
    </div>

    <script>
    (function() {
        var host = document.querySelector('#style-hat-ex');
        var root = host.createShadowRoot();
        root.innerHTML = '<span>Shadow DOM</span>' +
            '<content></content>';
    })();
    </script>

    <p>
        <strong>Example</strong>(custom elements) -
        <code>&lt;x-tabs&gt;</code>has
        <code>&lt;x-panel&gt;</code>children in its Shadow DOM. Each panel hosts its own shadow tree containing
        <code>h2</code>headings. To style those headings from the main page, one could write:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nt">x-tabs</span><span class="o">:</span><span class="nd">:shadow</span> <span class="nt">x-panel</span><span class="o">:</span><span class="nd">:shadow</span> <span class="nt">h2</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <h3 id="toc-style-cat">The /deep/ combinator</h3>

    <p>The
        <code>/deep/</code>combinator is similar to
        <code>::shadow</code>, but more powerful. It completely ignores all shadow boundaries and crosses into any number of shadow trees. Put simply,
        <code>/deep/</code>allows you to drill into an element&#8217;s guts and target any node.</p>
    <p>The
        <code>/deep/</code>combinator is particularly useful in the world of Custom Elements where it&#8217;s common to have multiple levels of Shadow DOM. Prime examples are nesting a bunch of custom elements (each hosting their own shadow tree) or creating an element that inherits from another using
        <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom-301/#toc-shadow-insertion"><code>&lt;shadow&gt;</code></a>.</p>
    <p>
        <strong>Example</strong>(custom elements) - select all<code>&lt;x-panel&gt;</code>elements that are descendants of<code>&lt;x-tabs&gt;</code>, anywhere in the tree:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nt">x-tabs</span> <span class="o">/</span><span class="nt">deep</span><span class="o">/</span> <span class="nt">x-panel</span> <span class="p">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <p>
        <strong>Example</strong>- style all elements with the class<code>.library-theme</code>, anywhere in a shadow tree:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nt">body</span> <span class="o">/</span><span class="nt">deep</span><span class="o">/</span> <span class="nc">.library-theme</span> <span class="p">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <h3 id="toc-css-traverasl">Working with querySelector()</h3>

    <p>Just like
        <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom-301/#toc-get-shadowroot"><code>.shadowRoot</code>
        </a>opens shadow trees up for DOM traversal, the combinators open shadow trees for selector traversal. Instead of writing a nested chain of madness, you can write a single statement:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>        <span class="c1">// No fun.</span>
</span><span class='line'>        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;x-tabs&#39;</span><span class="p">).</span><span class="nx">shadowRoot</span>
</span><span class='line'>                <span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;x-panel&#39;</span><span class="p">).</span><span class="nx">shadowRoot</span>
</span><span class='line'>                <span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#foo&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Fun.</span>
</span><span class='line'>        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;x-tabs::shadow x-panel::shadow #foo&#39;</span><span class="p">);</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <h3 id="toc-style-native">Styling native elements</h3>

    <p>Native HTML controls are a challenge to style. Many people simply give up and roll their own. However, with
        <code>::shadow</code>and
        <code>/deep/</code>, any element in the web platform that uses Shadow DOM can be styled. Great examples are the
        <code>&lt;input&gt;</code>types and
        <code>&lt;video&gt;</code>:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nt">video</span> <span class="o">/</span><span class="nt">deep</span><span class="o">/</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;range&quot;</span><span class="o">]</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">background</span><span class="o">:</span> <span class="nb">hotpink</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <div class="demoarea none">
        <video id="ex-style-video" controls=""></video>
    </div>

    <blockquote class="commentary talkinghead">
        Do the
        <code>::shadow</code>pseudo-element and
        <code>/deep/</code>combinator defeat the purpose of style encapsulation? Out of the box, Shadow DOM prevents
        <em>accidental</em>styling from outsiders but it never promises to be a bullet proof vest. Developers should be allowed to
        <em>intentionally</em>style inner parts of your Shadow tree&#8230;if they know what they&#8217;re doing. Having more control is also good for flexibility, theming, and the re-usability of your elements.
    </blockquote>

    <h2 id="toc-style-hooks">Creating style hooks</h2>

    <p>Customization is good. In certain cases, you may want to poke holes in your Shadow&#8217;s styling shield and create hooks for others to style.</p>
    <h3 id="toc-custom-pseduo">Using ::shadow and /deep/</h3>

    <p>There&#8217;s a lot of power behind
        <code>/deep/</code>. It gives component authors a way to designate individual elements as styleable or a slew of elements as themeable.</p>
    <p>
        <strong>Example</strong>- style all elements that have the class
        <code>.library-theme</code>, ignoring all shadow trees:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nt">body</span> <span class="o">/</span><span class="nt">deep</span><span class="o">/</span> <span class="nc">.library-theme</span> <span class="p">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <p></p>
    <h3 id="toc-vars">Using CSS Variables</h3>

    <p>A powerful way to create theming hooks will be through <a href="http://dev.w3.org/csswg/css-variables/">CSS Variables</a>. Essentially, creating &#8220;style placeholders&#8221; for other users to fill in.</p>
    <p>Imagine a custom element author who marks out variable placeholders in their Shadow DOM. One for styling an internal button&#8217;s font and another for its color:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nt">button</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">color</span><span class="o">:</span> <span class="o">+</span><span class="n">var</span> <span class="p">(</span><span class="n">button</span><span class="o">-</span><span class="k">text</span><span class="o">-</span><span class="k">color</span><span class="o">,</span> <span class="nb">pink</span><span class="p">);</span> <span class="c">/* default color will be pink */</span>
</span><span class='line'>          <span class="k">font</span><span class="o">:</span> <span class="o">+</span><span class="n">var</span> <span class="p">(</span><span class="n">button</span><span class="o">-</span><span class="k">font</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <p>Then, the embedder of the element defines those values to their liking. Perhaps to match the super cool Comic Sans theme of their own page:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="nf">#host</span> <span class="p">{</span>
</span><span class='line'>          <span class="o">+</span><span class="n">var</span><span class="o">-</span><span class="n">button</span><span class="o">-</span><span class="k">text</span><span class="o">-</span><span class="k">color</span><span class="o">:</span> <span class="nb">green</span><span class="p">;</span>
</span><span class='line'>          <span class="o">+</span><span class="n">var</span><span class="o">-</span><span class="n">button</span><span class="o">-</span><span class="k">font</span><span class="o">:</span> <span class="s2">&quot;Comic Sans MS&quot;</span><span class="o">,</span> <span class="s2">&quot;Comic Sans&quot;</span><span class="o">,</span> <span class="k">cursive</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <p>Due to the way CSS Variables inherit, everything is peachy and this works beautifully! The whole picture looks like this:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="o">&lt;</span><span class="nt">style</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="nf">#host</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">+</span><span class="n">var</span><span class="o">-</span><span class="n">button</span><span class="o">-</span><span class="k">text</span><span class="o">-</span><span class="k">color</span><span class="o">:</span> <span class="nb">green</span><span class="p">;</span>
</span><span class='line'>            <span class="o">+</span><span class="n">var</span><span class="o">-</span><span class="n">button</span><span class="o">-</span><span class="k">font</span><span class="o">:</span> <span class="s2">&quot;Comic Sans MS&quot;</span><span class="o">,</span> <span class="s2">&quot;Comic Sans&quot;</span><span class="o">,</span> <span class="k">cursive</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="o">&lt;/</span><span class="nt">style</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nt">div</span> <span class="nt">id</span><span class="o">=</span><span class="s2">&quot;host&quot;</span><span class="o">&gt;</span><span class="nt">Host</span> <span class="nt">node</span><span class="o">&lt;/</span><span class="nt">div</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nt">script</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="nt">var</span> <span class="nt">root</span> <span class="o">=</span> <span class="nt">document</span><span class="nc">.querySelector</span><span class="o">(</span><span class="s1">&#39;#host&#39;</span><span class="o">)</span><span class="nc">.createShadowRoot</span><span class="o">();</span>
</span><span class='line'>        <span class="nt">root</span><span class="nc">.innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;style&gt;&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;button {&#39;</span> <span class="o">+</span>
</span><span class='line'>              <span class="s1">&#39;color: +var (button-text-color, pink);&#39;</span> <span class="o">+</span>
</span><span class='line'>              <span class="s1">&#39;font: +var (button-font) ;&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;}&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;&lt;/style&gt;&#39;</span> <span class="o">+</span>
</span><span class='line'>            <span class="s1">&#39;&lt;content&gt;&lt;/content&gt;&#39;</span><span class="o">;</span>
</span><span class='line'>        <span class="o">&lt;/</span><span class="nt">script</span><span class="o">&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <blockquote class="commentary talkinghead">
        I&#8217;ve already mentioned <a href="http://Robing.github.io/tutorials/webcomponents/customelements/">Custom Elements</a> a few times in this article. For now, just know that Shadow DOM forms their structural foundation by providing styling and DOM encapsulation. The concepts here pertain to styling Custom Elements.
    </blockquote>

    <p></p>
    <h2 id="toc-style-disbtributed-nodes">Styling distributed nodes</h2>

    <p>Distributed nodes are elements that render at an <a href="http://Robing.github.io/tutorials/webcomponents/shadowdom-301/#toc-distributed-nodes">insertion point</a> (a
        <code>&lt;content&gt;</code>element). The
        <code>&lt;content&gt;</code>element allows you to select nodes from the Light DOM and render them at predefined locations in your Shadow DOM. They&#8217;re not logically in the Shadow DOM; they&#8217;re still children of the host element. Insertion points are just a rendering thing.</p>
    <p>Distributed nodes retain styles from the main document. That is, style rules from the main page continue to apply to the elements, even when they render at an insertion point. Again, distributed nodes are still logically in the light dom and don&#8217;t move. They just render elsewhere. However, when the nodes get distributed into the Shadow DOM, they can take on additional styles defined inside the shadow tree.</p>
    <h3 id="toc-distributed">::content pseudo element</h3>

    <p>Distributed nodes are children of the host element, so how can we target them from
        <em>within</em>the Shadow DOM? The answer is the CSS
        <code>::content</code>pseudo element. It&#8217;s a way to target Light DOM nodes that pass through an insertion point. For example:</p>
    <p>
        <code>::content &gt; h3</code>styles any
        <code>h3</code>tags that pass through an insertion point.</p>
    <p>Let&#8217;s see an example:</p>
    
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'>        <span class="o">&lt;</span><span class="nt">div</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="nt">h3</span><span class="o">&gt;</span><span class="nt">Light</span> <span class="nt">DOM</span><span class="o">&lt;/</span><span class="nt">h3</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="nt">section</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nt">div</span><span class="o">&gt;</span><span class="nt">I</span><span class="s1">&#39;m not underlined&lt;/div&gt;</span>
</span><span class='line'><span class="s1">            &lt;p&gt;I&#39;</span><span class="nt">m</span> <span class="nt">underlined</span> <span class="nt">in</span> <span class="nt">Shadow</span> <span class="nt">DOM</span><span class="o">!&lt;/</span><span class="nt">p</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;/</span><span class="nt">section</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;/</span><span class="nt">div</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">&lt;</span><span class="nt">script</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="nt">var</span> <span class="nt">div</span> <span class="o">=</span> <span class="nt">document</span><span class="nc">.querySelector</span><span class="o">(</span><span class="s1">&#39;div&#39;</span><span class="o">);</span>
</span><span class='line'>        <span class="nt">var</span> <span class="nt">root</span> <span class="o">=</span> <span class="nt">div</span><span class="nc">.createShadowRoot</span><span class="o">();</span>
</span><span class='line'>        <span class="nt">root</span><span class="nc">.innerHTML</span> <span class="o">=</span> <span class="s1">&#39;\</span>
</span><span class='line'><span class="s1">            &lt;style&gt;\</span>
</span><span class='line'><span class="s1">              h3 { color: red; }\</span>
</span><span class='line'><span class="s1">              content[select=&quot;h3&quot;]::content &gt; h3 {\</span>
</span><span class='line'><span class="s1">                color: green;\</span>
</span><span class='line'><span class="s1">              }\</span>
</span><span class='line'><span class="s1">              ::content section p {\</span>
</span><span class='line'><span class="s1">                text-decoration: underline;\</span>
</span><span class='line'><span class="s1">              }\</span>
</span><span class='line'><span class="s1">            &lt;/style&gt;\</span>
</span><span class='line'><span class="s1">            &lt;h3&gt;Shadow DOM&lt;/h3&gt;\</span>
</span><span class='line'><span class="s1">            &lt;content select=&quot;h3&quot;&gt;&lt;/content&gt;\</span>
</span><span class='line'><span class="s1">            &lt;content select=&quot;section&quot;&gt;&lt;/content&gt;&#39;</span><span class="o">;</span>
</span><span class='line'>        <span class="o">&lt;/</span><span class="nt">script</span><span class="o">&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>

    <div class="demoarea none">
        <div id="style-ex-distributed">
            <h3>Light DOM</h3>
            <section>
                <div>I&#8217;m not underlined</div>
                <p>I&#8217;m underlined in Shadow DOM!</p>
            </section>
        </div>
    </div>

    <script>
    (function() {
        var container = document.querySelector('#style-ex-distributed');
        var root = container.createShadowRoot();
        root.innerHTML = '\
  <style>\
    h3 { color: red; }\
    content[select="h3"]::content > h3 {\
      color: green;\
    }\
    ::content section p {\
      text-decoration: underline;\
    }\
  </style>\
  <h3>Shadow DOM</h3>\
  <content select="h3"></content>\
  <content select="section"></content>';
    })();
    </script>

    <p>You should see &#8221;
        <span style="color:red">Shadow DOM</span>&#8221; and &#8221;
        <span style="color:green">Light DOM</span>&#8221; below it. Also note that &#8220;Light DOM&#8221; is still retaining the styles (margins etc.) defined on this page. That&#8217;s because the page&#8217;s styles still match!</p>
    <p></p>


    <blockquote class="commentary talkinghead">
        Remember: styles defined in the host document continue to apply to nodes they target, even when those nodes get distributed &#8220;inside&#8221; the Shadow DOM. Going into an insertion point doesn&#8217;t change what&#8217;s applied.
    </blockquote>

    <h2 id="toc-conclusion">Conclusion</h2>

    <p>As authors of custom elements, we have a ton of options for controlling the look and feel of our content. Shadow DOM forms the basis for this brave new world.</p>
    <p>Shadow DOM gives us scoped style encapsulation and a means to let in as much (or as little) of the outside world as we choose. By defining custom pseudo elements or including CSS Variable placeholders, authors can provide third-parties convenient styling hooks to further customize their content. All in all, web authors are in full control of how their content is represented.</p>
    <p class="small-notice">
        Thanks to <a href="http://Robing.github.io/profiles/#dominiccooney">Dominic Cooney</a> and
        <a href="https://plus.google.com/111648463906387632236/posts">Dimitri Glazkov</a> for reviewing the content of this tutorial.
    </p>

    <p>
    </p>
    <aside class="panel">
        <h2>Related reading</h2>
        <ul>
            <li><a href="http://Robing.github.io/tutorials/webcomponents/shadowdom/">Shadow DOM 101</a>
            </li>
            <li><a href="http://Robing.github.io/tutorials/webcomponents/shadowdom-301/">Shadow DOM 301 - Advanced Concepts &amp; DOM APIs</a>
            </li>
            <li><a href="http://Robing.github.io/tutorials/webcomponents/customelements/">Custom Elements - defining new elements in HTML</a>
            </li>
        </ul>
    </aside>
    <p></p>
    <script>
    document.addEventListener('DOMContentLoaded', function(e) {
        if (!isCompatible()) {
            document.body.classList.add('disabledemos');
            $('.featuresupported').removeClass('no');
        }
    });
    </script>

</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shadow DOM 一]]></title>
    <link href="http://Robing.github.io/blog/2014/05/16/shadow-dom-101/"/>
    <updated>2014-05-16T10:09:17+08:00</updated>
    <id>http://Robing.github.io/blog/2014/05/16/shadow-dom-101</id>
    <content type="html"><![CDATA[<div class="content" id="article-content">        
<p></p>

<h2 id="toc-introduction">介绍</h2>

<p>
Web 组件是一系列前沿规范，它：
</p>

<ol>
<li>使得构建部件(widget)成为可能</li>
<li>…重用更为可靠</li>
<li>
…即便后续版本的组件修改了内部实现细节也不会使页面出错。
</li>
</ol>

<p>
这是否意味着你得决定什么时候用 HTML/JavaScript，什么时候用 Web 组件？不！HTML 和 JavaScript 可以制作交互式可视化内容，
部件也是交互式可视化内容。在开发部件的过程中自然而然的就会利用你的 HTML 和 JavaScript 技巧。Web 组件标准就是以此为目的而设计的。
</p>

<blockquote class="commentary talkinghead">
若是使用别的技术来构建部件却也说不通。比如，我就肯定不会推荐你用 <code>&lt;canvas&gt;</code> 来写部件。它确实可靠——如果你修改绘制的内容也不会破坏页面——但它对可访问性(accessibility)，索引(indexing)，组合(composition)，分辨率无关(resolution independence)都不友好。
</blockquote>

<p>
但有个根本问题，导致 HTML 和 JavaScript 构建出来的部件难以使用：部件中的 DOM 树并没有封装起来。
封装的缺乏意味着文档中的样式表会无意中影响部件中的某些部分；
JavaScript 可能在无意中修改部件中的某些部分；你书写的 ID 也可能会把部件内部的 ID 覆盖。
</p>

<blockquote class="commentary">
缺乏封装的一个明显缺点在于：如果你更新了库或者部件的 DOM 更改了内部细节，你的样式和脚本就可能在不经意间遭到破坏。
</blockquote>

<p>
Web 组件由四部分组成：
</p>

<ol>
<li><a href="https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/templates/index.html">Templates</a></li>
<li><a href="http://www.w3.org/TR/shadow-dom/">Shadow
DOM</a></li>
<li><a href="https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/custom/index.html">Custom
Elements</a></li>
<li><a href="https://dvcs.w3.org/hg/webcomponents/raw-file/tip/explainer/index.html#external-custom-elements-and-decorators">Packaging</a></li>
</ol>

<p>
<b>Shadow DOM</b> 解决了 DOM 树的封装问题。Web 组件的四部分被设计成配合工作，但你也可以选择 Web 组件中的某个部分来使用。该教程将教会你如何使用 Shadow DOM。
</p>

<p class="notice">
<b>注意：</b> Chrome 25+ 支持 Shadow DOM，但 API 需要加 <code>webkit</code> 前缀。 在 Chrome 的最新版本中增加了无前缀的 API，可以通过开启 <code>about:flags</code> 下的 &#8220;实验性网络平台功能&#8221;来使用。
</p>

<h2 id="toc-hello-world">Hello, Shadow World</h2>

<p>
有了 Shadow DOM，元素就可以和一个新类型的节点关联。这个新类型的节点称为 <b>shadow root。</b>与一个 shadow root 关联的元素称作一个 <b>shadow host。</b>shadow host 的内容不会渲染；shadow root 的内容会渲染。
</p>
<!-- more -->
<p>
比如，你拥有如下的标记：
</p>

<span class="tag">&lt;button&gt;</span><span class="pln">Hello, world!</span><span class="tag">&lt;/button&gt;</span><span class="pln">
</span><span class="tag">&lt;script&gt;</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> host </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">&#8216;button&#8217;</span><span class="pun">);</span><span class="pln">
</span><b><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> host</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span></b><span class="pln">
root</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">&#8216;こんにちは、影の世界!&#8217;</span><span class="pun">;</span><span class="pln">
</span><span class="tag">&lt;/script&gt;</span>


<p>因此，相比显示以下内容</p>

<button id="ex1a">Hello, world!</button>
<script>
function remove(selector) {
  Array.prototype.forEach.call(
      document.querySelectorAll(selector),
      function (node) { node.parentNode.removeChild(node); });
}

if (!HTMLElement.prototype.webkitCreateShadowRoot) {
  remove('#ex1a');
  document.write('<img src="SS1.png" alt="Screenshot of a button with \'Hello, world!\' on it.">');
}
</script>

<p>页面将会呈现如下内容</p>

<button id="ex1b">Hello, world!</button>
<script>
(function () {
  if (!HTMLElement.prototype.webkitCreateShadowRoot) {
    remove('#ex1b');
    document.write('<img src="SS2.png" alt="Screenshot of a button with \'Hello, shadow world!\' in Japanese on it.">');
    return;
  }
  var host = document.querySelector('#ex1b');
  var root = host.webkitCreateShadowRoot();
  root.textContent = 'こんにちは、影の世界!';
})();
</script>

<p>
不仅如此，若页面中的 JavaScript 想获得按钮的 <span class="property">textContent</span> 是什么，它不会得到 “こんにちは、影の世界!”，而是 “Hello, world!”，因为 shadow root 下的 DOM 子树被封装了起来。
</p>

<p>
介绍一个(可能不被遵守的)经验法则，
你不应该把<em>内容</em>放到 Shadow DOM 中。内容必须放入文档内以便屏幕阅读器，搜索引擎，扩展等类似程序可以访问到。
在创建一个吸引人的，可重用的部件时，那些无意义的标记要放进 Shadow DOM 中，可内容还得留在页面里。
</p>

<blockquote class="commentary talkinghead">
当然，这并不是必须遵守的；在 web 上你可以按照自己的喜好来做。但千万别过火。
</blockquote>

<h2 id="toc-separation">从展现中分离内容</h2>

<p>
现在我们来看看如何使用 Shadow DOM 来将内容从展现中分离出来。假设我们拥有如下姓名卡：
</p>
<style>
.ex2a.outer {
  border: 2px solid brown;
  border-radius: 1em;
  background: red;
  font-size: 20pt;
  width: 12em;
  height: 7em;
  text-align: center;
}
.ex2a .boilerplate {
  color: white;
  font-family: sans-serif;
  padding: 0.5em;
}
.ex2a .name {
  color: black;
  background: white;
  font-family: &#8220;Marker Felt&#8221;, cursive;
  font-size: 45pt;
  padding-top: 0.2em;
}
</style>
<div class="ex2a outer">
  <div class="boilerplate">
    Hi! My name is
  </div>
  <div class="name">
    Bob
  </div>
</div>

<p>
以下是标记，它并没有使用 Shadow DOM：
</p>
  
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;style&gt;</span>
</span><span class='line'>      <span class="nc">.outer</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">border</span><span class="o">:</span> <span class="m">2px</span> <span class="k">solid</span> <span class="nb">brown</span><span class="p">;</span>
</span><span class='line'>        <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-size</span><span class="o">:</span> <span class="m">20pt</span><span class="p">;</span>
</span><span class='line'>        <span class="k">width</span><span class="o">:</span> <span class="m">12em</span><span class="p">;</span>
</span><span class='line'>        <span class="k">height</span><span class="o">:</span> <span class="m">7em</span><span class="p">;</span>
</span><span class='line'>        <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nc">.boilerplate</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-family</span><span class="o">:</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>        <span class="k">padding</span><span class="o">:</span> <span class="m">0.5em</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nc">.name</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">color</span><span class="o">:</span> <span class="nb">black</span><span class="p">;</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-family</span><span class="o">:</span> <span class="s2">&quot;Marker Felt&quot;</span><span class="o">,</span> <span class="k">cursive</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-size</span><span class="o">:</span> <span class="m">45pt</span><span class="p">;</span>
</span><span class='line'>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">0.2em</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;outer&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;boilerplate&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          Hi! My name is
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          Bob
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>
因为 DOM 树缺乏封装，整个姓名卡的结构都暴露给了文档。若是页面里其他的元素不经意间使用了同样的类名来设置样式或操作脚本，那么我们可就有苦日子过了。
</p>

<p>我们完全可以避免这样的情况发生</p>

<h3 id="toc-separation-hide">第一步：隐藏展现细节</h3>

<p>
从语义上讲，我们可能只关心如下内容：
</p>

<ul>
<li>这是一个姓名卡。</li>
<li>名称是 “Bob”。</li>
</ul>

<p>
首先，我们先按照最接近我们关心的语义的方式来书写标记：
</p>

  
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;nameTag&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>
接下来我们把所有和展现相关的样式和 div 都放入一个 <code>&lt;template&gt;</code> 元素内：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;nameTag&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;template</span> <span class="na">id=</span><span class="s">&quot;nameTagTemplate&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;style&gt;</span>
</span><span class='line'>      <span class="nc">.outer</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">border</span><span class="o">:</span> <span class="m">2px</span> <span class="k">solid</span> <span class="nb">brown</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="err">…</span> <span class="err">和上面一样</span> <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;outer&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;boilerplate&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          Hi! My name is
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          Bob
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/template&gt;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>
此时，‘Bob’ 是唯一被渲染的内容。因为我们把与展现有关的 DOM 元素移动到了一个 <code>&lt;template&gt;</code> 元素内，它们是不会被渲染的，但是它们<em>能够</em>通过 JavaScript 来访问。接下来我们就会通过脚本来填充 shadow root：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">shadow</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#nameTag&#39;</span><span class="p">).</span><span class="nx">createShadowRoot</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#nameTagTemplate&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">shadow</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">template</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote class="commentary talkinghead">
Templates，和 Shadow DOM 一样，也是一个完善中的规范。Chrome Canary 支持 <code>&lt;template&gt;</code> 元素。你也可以选择使用 <span class="property">innerHTML</span>，<span class="method">appendChild</span>，<span class="method">getElementById</span> 这样的方法或属性来填充 shadow root。本文主要讨论 Shadow DOM，所以不会涉及太多 template 元素的工作原理。如果你想了解更多 <code>&lt;template&gt;</code> 的内容，查看 <a href="http://Robing.github.io/tutorials/webcomponents/template/">HTML 的新 Template 标签</a>.
</blockquote>

<p>
我们建立了一个 shadow root，姓名卡被再次渲染。如果你右键点击标签，选择检查元素，你将看到漂亮并富于语义的标记：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;nameTag&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
这便印证了，通过使用 Shadow DOM，我们可以将展现细节隐藏在姓名卡中。展现细节被封装在了 Shadow DOM 中。
</p>

<h3 id="toc-separation-separate">
第二步：从展现中分离内容
</h3>

<p>
现在我们的姓名卡可以从页面中隐藏展现细节了，但展现和内容却没有分离，
因为虽然内容(就是姓名“Bob”)显示在了页面里，但这个姓名是从 shadow root 中复制过来的。
如果我们想修改姓名卡的姓名，就得修改两个地方，这就可能造成它们不同步。
</p>

<p>
HTML 元素是可组合的 — 比如说你可以把一个按钮放进一个表格里。
在这儿我们就需要使用组合：姓名卡必须将红色背景，“Hi!”文本，和标签内容组合在一起。
</p>

<p>
作为组件作者的你定义了一个 <code>&lt;content&gt;</code> 元素来完成部件的组合工作。
这为部件的展现创建了一个插入点(insertion point)，而该插入点将挑选 shadow host 里的内容显示到该点所在的位置上。
</p>

<p>
如果我们把 Shadow DOM 里的标记做如下修改：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;template</span> <span class="na">id=</span><span class="s">&quot;nameTagTemplate&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;style&gt;</span>
</span><span class='line'>        <span class="err">…</span>
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;outer&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;boilerplate&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          Hi! My name is
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;content&gt;&lt;/content&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/template&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
当姓名卡渲染后，shadow host 的内容便投射(projected)到 <code>&lt;content&gt;</code> 元素出现的地方。
</p>

<p>
现在文档的结构简单了，因为名称只出现在了一个地方——就在文档里。如果想更新用户名称，你只需写：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    document.querySelector(&#39;#nameTag&#39;).textContent = &#39;Shellie&#39;;
</span></code></pre></td></tr></table></div></figure>


<p>
这就足够了。浏览器会自动更新渲染的姓名卡，因为我们把姓名卡的内容<b>投射</b>到了 <code>&lt;content&gt;</code> 元素内。
</p>

<div id="ex2b">

<p>下面是使用 Shadow DOM 的实例：</p>

<div id="ex2bNameTag">Bob</div>

<p>
<label for="ex2bNewName">新名字：</label>
<input name="ex2bNewName" value="Shellie">
<button onclick="updateClicked('#ex2bNameTag', 'input[name=ex2bNewName]');">更新</button>
</p>

<script>
function updateClicked(nameTagSelector, textBoxSelector) {
  var text = document.querySelector(textBoxSelector);
  document.querySelector(nameTagSelector).textContent = text.value;
  text.value = '';
  text.focus();
}
</script>


<script>
(function () {
  if (!window.HTMLTemplateElement ||
      !HTMLElement.prototype.webkitCreateShadowRoot) {
    remove('#ex2b');
    return;
  }

  var shadow = document.querySelector('#ex2bNameTag').webkitCreateShadowRoot();
  var template = document.querySelector('#ex2bNameTagTemplate');
  shadow.appendChild(template.content);
  template.remove();
})();
</script>
</div>


<p>
我们实现了分离内容和展现的目的。<b>内容在文档内；展现在 Shadow DOM 里。</b>
当需要更新的时候，浏览器会自动保持它们的同步。
</p>

<h3 id="toc-separation-profit">第三步：福利</h3>

<p>
通过分离内容和展现，我们可以简化操作内容的代码——在姓名卡的例子中，代码只需要和包含一个 <code>&lt;div&gt;</code> 标签的简单结构打交道，而不必操作多个标签。
</p>

<p>
如果此时我们修改展现，就不用动任何代码了！
</p>

<p>
比方说，我们想将姓名卡本地化。因为它仍然是一个姓名卡，所以它在文档中的语义内容没有改变：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;nameTag&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
设置 shadow root 的代码保持不变。只是放进 shadow root 中的内容变了：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;template</span> <span class="na">id=</span><span class="s">&quot;nameTagTemplate&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;style&gt;</span>
</span><span class='line'>      <span class="nc">.outer</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">border</span><span class="o">:</span> <span class="m">2px</span> <span class="k">solid</span> <span class="nb">pink</span><span class="p">;</span>
</span><span class='line'>        <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="sx">url(sakura.jpg)</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-size</span><span class="o">:</span> <span class="m">20pt</span><span class="p">;</span>
</span><span class='line'>        <span class="k">width</span><span class="o">:</span> <span class="m">12em</span><span class="p">;</span>
</span><span class='line'>        <span class="k">height</span><span class="o">:</span> <span class="m">7em</span><span class="p">;</span>
</span><span class='line'>        <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-family</span><span class="o">:</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-weight</span><span class="o">:</span> <span class="k">bold</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nc">.name</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">font-size</span><span class="o">:</span> <span class="m">45pt</span><span class="p">;</span>
</span><span class='line'>        <span class="k">font-weight</span><span class="o">:</span> <span class="k">normal</span><span class="p">;</span>
</span><span class='line'>        <span class="k">margin-top</span><span class="o">:</span> <span class="m">0.8em</span><span class="p">;</span>
</span><span class='line'>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">0.2em</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;outer&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;content&gt;&lt;/content&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>        と申します。
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/template&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
现在我们有了一个日文的姓名卡：
</p>
<div id="ex3a">
<div id="ex3aNameTag">Bob</div>
<p>
<label for="ex3aNewName">新名字：</label>
<input name="ex3aNewName" value="基子">
<button onclick="updateClicked('#ex3aNameTag', 'input[name=ex3aNewName]');">更新</button>
</p>
</div>

<script>
(function () {
  if (!window.HTMLTemplateElement ||
      !HTMLElement.prototype.webkitCreateShadowRoot) {
    remove('#ex3a');
    document.write('<img src="SS4.png" alt="A name tag with a watercolor painting of cherry blossoms on it.">');
    return;
  }
  var shadow = document.querySelector('#ex3aNameTag').webkitCreateShadowRoot();
  var template = document.querySelector('#ex3aNameTagTemplate');
  shadow.appendChild(template.content);
  template.remove();
})();
</script>

<p class="small-notice">
<a href="http://www.flickr.com/photos/mikedowman/5621169045/">背景图片来自于 Mike Dowman，</a> 基于 Creative Commons license 重用。
</p>

<p>
在当今的 web 环境下这是一个巨大的进步，因为更新名字的代码可以依赖于简单且一致的<em>组件</em>的结构，
<strong>而无需知晓用于渲染的结构。</strong> 比如说从渲染的角度考虑，在英文中名称应该出现在第二行(在 “Hi! My name is” 之后)，但是在日文中需要出现在第一行(在 “と申します” 之前)。从更新名称的角度来说，这个区别对于语义没有任何意义，因此名称更新代码并不需要了解这些细节。
</p>

<h2 id="toc-projection">额外福利：高级投射</h2>

<p>
在上面的例子中，<code>&lt;content&gt;</code> 元素挑选了 shadow host 的所有内容。通过使用
<span class="attribute">select</span> 特性，你可以控制 content 元素投射的内容。你也可以使用多个 content 元素。
</p>

<p>
比如说，如果你有一个包含如下内容的文档：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;nameTag&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;first&quot;</span><span class="nt">&gt;</span>Bob<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div&gt;</span>B. Love<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>bob@<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>
shadow root 使用 CSS 选择器来选择特定内容：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;background: purple; padding: 1em;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;color: red;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;content</span> <span class="na">select=</span><span class="s">&quot;.first&quot;</span><span class="nt">&gt;&lt;/content&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;color: yellow;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;content</span> <span class="na">select=</span><span class="s">&quot;div&quot;</span><span class="nt">&gt;&lt;/content&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;color: blue;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;content</span> <span class="na">select=</span><span class="s">&quot;.email&quot;</span><span class="nt">&gt;&lt;/content&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p class="notice"><b>注意：</b> <span class="attribute">select</span> 只能选择 host 节点的直接子元素。也就是说，你不能选择后代元素(例如 <code>select="table tr"</code>)。</p>

<p>
<code>&lt;div class="email"&gt;</code> 元素同时被 <code>&lt;content select="div"&gt;</code> 和 <code>&lt;content
select=".email"&gt;</code> 元素所匹配。那 Bob 的电子邮件地址会出现多少次，都是什么颜色？
</p>

<div id="ex4a">

<div id="ex4aNameTag">
  <div class="first">Bob</div>
  <div>B. Love</div>
  <div class="email">bob@</div>
</div>


</div>

<script>
(function () {
  if (!window.HTMLTemplateElement ||
      !HTMLElement.prototype.webkitCreateShadowRoot) {
    remove('#ex4a');
    document.write('<img src="SS5.png" alt="The rendered result. Bob’s email appears in yellow." id="ex4a">');
    return;
  }
  var shadow = document.querySelector('#ex4aNameTag').webkitCreateShadowRoot();
  var template = document.querySelector('#ex4aNameTagTemplate');
  shadow.appendChild(template.content);
  template.remove();
})();
</script>

<p>
答案是：Bob 的电子邮件地址仅显示一次，并且是黄色的。
</p>

<p>
为什么会这样？那些了解 Shadow DOM 原理的人们都知道，把最终渲染在屏幕上的内容构建成一棵树，就像举办一个盛大的舞会。
<strong>content 元素就是将文档中的内容邀请到 Shadow DOM 渲染舞会的请柬。</strong>
这些请柬按顺序发放；谁能收到邀请取决于请柬的地址(即 <span class="attribute">select</span> 特性。)，
一旦收到邀请，便会接受请柬(有谁不会呢？！)立即动身。如果接下来又有一封请柬发送到该地址，可现在家里没人，这个舞会也就去不了了。
</p>

<p>
在上面的例子中，<code>&lt;div class="email"&gt;</code> 同时匹配 <code>div</code> 选择器和 <code>.email</code> 选择器，但因为含有 <code>div</code> 选择器的 content 元素在文档中的位置靠前，
<code>&lt;div class="email"&gt;</code> 便去了黄色舞会，这样就没人去蓝色舞会了。
</p>

<p>
如果有内容<em>没有</em>被邀请参加任何舞会，那它就不会渲染。第一个例子中的 “Hello, world” 文本便属于这种情况。
这对于当你想彻底修改渲染内容时十分有效：在文档中书写语义模型，它能够被页面中的脚本访问到，但是基于渲染原因必须将它隐藏起来，使用 JavaScript 将它与 Shadow DOM 中的一个完全不同的渲染模型进行关联。
</p>

<p>
举个例子，HTML 有一个不错的日期选择器。如果你写下 <code>&lt;input
type="date"&gt;</code> 你将得到一个简洁的弹出式日历。但如果你想让用户为他们的<i>甜点</i>
岛旅行选择一段日期(你知道吗……岛上有红葡萄藤做的吊床。)，文档表面上是这么写的：
</p>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;dateRangePicker&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;start&quot;</span><span class="nt">&gt;</span>Start:<span class="nt">&lt;/label&gt;</span>
</span><span class='line'>      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">name=</span><span class="s">&quot;startDate&quot;</span> <span class="na">id=</span><span class="s">&quot;start&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;br&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;end&quot;</span><span class="nt">&gt;</span>End:<span class="nt">&lt;/label&gt;</span>
</span><span class='line'>      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;date&quot;</span> <span class="na">name=</span><span class="s">&quot;endDate&quot;</span> <span class="na">id=</span><span class="s">&quot;end&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
但实际上会创建一个 Shadow DOM，在里面使用表格生成一个能够高亮日期范围的日历。
当用户点击日历中的日期，组件会更新输入框的起始日期和结束日期；当用户提交表单，两个输入框元素的值就会被提交。
</p>

<p>
你可能会奇怪，为什么我明知道 label 元素不会被渲染还去写它呢？
原因在于如果用户通过一个不支持 Shadow DOM 的浏览器来访问表单，
那么表单还是保证可用的，只是不太漂亮。最终看起来可能是这样的：
</p>

<div class="dateRangePicker">
  <label for="start">Start:</label>
  <input type="date" name="startDate" id="start">
  <br>
  <label for="end">End:</label>
  <input type="date" name="endDate" id="end">
</div>

<h2 id="toc-conclusion">你通过了 Shadow DOM 101</h2>

<p>
这里介绍的是 Shadow DOM 的基础——你通过了 Shadow DOM 101！
你可以使用 Shadow DOM 实现更多事情，比方说在一个 shadow host 内使用多个 shadow DOM，
或是出于封装的缘故来嵌套 shadow DOM，或是使用 Model-Driven Views (MDV) 和 Shadow DOM 来架构页面。
而且 Web 组件可不仅仅包含 Shadow DOM。使用 Web 组件的另一部分：自定义元素，你就可以用声明的方式来设置部件的 Shadow DOM，而不必去写脚本了。
</p>

<p>
我们将在后续文章中解释这些内容。好了，请在<a href="https://plus.google.com/103330502635338602217/posts">Google+ 上关注 Web 组件吧。</a>
</p>

<p class="small-notice">
感谢 <a href="http://Robing.github.io/profiles/#ericbidelman">Eric Bidelman，</a>Darin
Fisher，Dimitri Glazkov，Alex Komoroske，Alex Russell，和 <a href="http://Robing.github.io/profiles/#paulirish">Paul Irish</a> 对本教程早期版本提出的建议。
</p>


      </div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Css3 Animation]]></title>
    <link href="http://Robing.github.io/blog/2014/05/15/css3-animation/"/>
    <updated>2014-05-15T22:28:04+08:00</updated>
    <id>http://Robing.github.io/blog/2014/05/15/css3-animation</id>
    <content type="html"><![CDATA[<h3>Introduction</h3>




<p>Ladies and gentlemen, it is the second decade of the second millennium and we are still kicking around the same 2D interface we got three decades ago. Sure, Apple debuted a few apps for OSX 10.7 that have a couple more 3D flourishes, and Microsoft has had thatFlip 3Dfor a while. But c’mon, 2011 is right around the corner. That’sTwenty Elevenfolks. Where is our 3D virtual reality? By now, we should be zipping around theMetaverse in super-sonic motorbikes.</p>




<p>Granted, the capability of rendering complex 3D environments has been present for years. On the Web, there already are number of solutions –Flash,three.jsin canvas, and eventually WebGL. And finally, we meager front-end developers have our own three-dimensional jewel: CSS 3D Transforms!</p>




<h3>Rationale</h3>




<p>Like a beautiful jewel, 3D transform can be dazzling, a true spectacle to behold. But before we start tacking 3D diamonds and rubies to our compositions like Liberace’s tailor, we owe it to our users to ask what can they benefit from this awesome feature.</p>




<p>The entire application does not, and should not, take advantage of 3D. CSS was built to style documents, not generate explorable environments. I fail to find a benefit to filling out a web form that can be accessed by swiveling my viewport to the Sign-Up Room (although there have been proposals to make the Web just that). However, there is plenty of opportunity to use 3D transformsin betweenthe interface, via transitions.</p>




<p>Take for instance the Weather App on the iPhone. The application uses two views: a details view and an options view. Switching between these two views is done with a 3D flip transition. This affords the user that the interface has two and only two views, as they can only exist on either side of the same plane.</p>




<!-- more -->




<p>Also consider slide cycle plugins. When you’re at the last slide, what cues tip-off the user that the advancing will re-start the cycle at the first? A better paradigm can be used with a 3D transform, where the slides are placed side by side one another in a circle in 3D space. In that arrangement, the last slide logically comes before the first.</p>




<p>3D transforms are more than just eye candy. We can also use them to solve dilemmas and make our applications more intuitive.</p>




<p>Current Support Environment</p>




<p>The CSS 3D transforms modulehas been out in the wild for several year now. While only Apple-produced browsers like Safari and Mobile Safari originally supported it, support has been added by Google Chrome and Mozilla Firefox. View the chart oncaniuse.com/#feat=transforms3dto check the latest support environment across the browser landscape.</p>




<p>This all adds up to a bit of a challenge for those of us excited for 3D transforms. I’ll give it to you straight: missing that dimension of depth can make degradation a bit ungraceful. Unless the transform is relatively simple and holds up in non-3D-supporting browsers, you’ll most likely have to design another solution. But what’s another hurdle in a steeplechase? We web folk have had our mettle tested for years. We’re galvanized for devising multiple solutions.</p>




<p>Here’s the part of the article where I mentionModernizr, and you brush over it because you’ve read this part of an article a hundreds of times before. But seriously, it’s the best way to test for CSS 3D transform support. Use it.</p>




<p>Even with these difficulties mounted up, trying out 3D transforms today is the right move. The CSS 3D transforms module was developed by the same team at Apple who produced theCSS 2D transformsandanimation. Both specifications have since been adopted by Mozilla and Opera. Transforming three-dimensionally now will guarantee you’ll be ahead of the game when the other browsers catch up.</p>




<p>The choice is yours. You can make excuses and poo-poo 3D transforms because they’re too hard and only snobby Apple fans will see them today. Or, with atip of the fedora to Mr. Andy Clarke, you can get hardboiled and start designing with the best features out there right this instant.</p>




<p>So I bid you,in the words of the eternal Optimus Prime…</p>




<p>Transform and roll out.</p>




<p>Let’s get coding.</p>

]]></content>
  </entry>
  
</feed>
