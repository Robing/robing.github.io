
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Shadow DOM 301 - Rainer's blog</title>
  <meta name="author" content="Robin">

  
  <meta name="description" content="This article discusses more of the amazing things you can do with Shadow DOM! It builds on the concepts discussed in Shadow DOM 101
and Shadow DOM &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://Robing.github.io/blog/2014/05/16/shadow-dom-301">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Rainer's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Rainer's blog</a></h1>
  
    <h2>Focus on Html5 css3 mobile development</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:Robing.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Shadow DOM 301</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-16T12:21:36+08:00" pubdate data-updated="true">May 16<span>th</span>, 2014</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://Robing.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><div class="content" id="article-content">
<p>This article discusses more of the amazing things you can do with Shadow DOM! It builds on the concepts discussed in <a href="/tutorials/webcomponents/shadowdom/">Shadow DOM 101</a>
and <a href="/tutorials/webcomponents/shadowdom-201/">Shadow DOM 201</a>.</p>
<p class="tip notice">In Chrome, turn on the &#8220;Enable experimental Web Platform features&#8221; in about:flags to experiment with everything covered in this article.</p>

<h2 id="toc-shadow-multiple">Using multiple shadow roots</h2>

<p>If you&#8217;re hosting a party, it gets stuffy if everyone is crammed into the same room.
You want the option of distributing groups of people across multiple rooms. Elements hosting
Shadow DOM can do this too, that is to say, they can host more than one shadow
root at a time.</p>
<p>Let&#8217;s see what happens if we try to attach multiple shadow roots to a host:</p>
<pre class="prettyprint"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"example1"</span><span class="tag">&gt;</span><span class="pln">Light DOM</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;script&gt;</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> container </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'#example1'</span><span class="pun">);</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> root1 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> root2 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
root1</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;div&gt;Root 1 FTW&lt;/div&gt;'</span><span class="pun">;</span><span class="pln">
root2</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;div&gt;Root 2 FTW&lt;/div&gt;'</span><span class="pun">;</span><span class="pln">
</span><span class="tag">&lt;/script&gt;</span></pre>

<div class="demodevtools"> 
<img src="http://rainer.qiniudn.com/stacking.png" title="Attaching multiple shadow trees" alt="Attaching multiple shadow trees" style="width:250px;">
</div>

<div class="demoarea">
  <div id="example1">Light DOM</div>
</div>

<script>
(function() {
var container = document.querySelector('#example1');
var root1 = container.createShadowRoot();
var root2 = container.createShadowRoot();
root1.innerHTML = '<div>Root 1 FTW</div>';
root2.innerHTML = '<div>Root 2 FTW</div>';
})();
</script>

<p class="notice tip">In the DevTools, turn on &#8220;Show Shadow DOM&#8221; to be
  able to inspect ShadowRoots.</p>

<p>What renders is &#8220;Root 2 FTW&#8221;, despite the fact that we had already attached a shadow tree.
This is because the last shadow tree added to a host, wins. It&#8217;s a LIFO stack as
far as rendering is concerned. Examining the DevTools verifies this behavior.</p>
<p class="notice fact">Shadow trees added to a host are stacked in the order they&#8217;re added,
starting with the most recent first. The last one added is the one that renders.</p>

<blockquote class="commentary talkinghead" id="youngest-tree">
The most recently added tree is called the <b>younger tree</b>. Previous trees are called <b>older trees</b>. In this example, <code>root2</code> is the younger tree and  <code>root1</code> is the older tree.
</blockquote>

<p>So what&#8217;s the point of using multiple shadows if only the last is invited to the
rendering party? Enter shadow insertion points.</p>
<h3 id="toc-shadow-insertion">Shadow Insertion Points</h3>

<!-- more -->

<p>&#8220;Shadow insertion points&#8221; (<code>&lt;shadow&gt;</code>) are similar to normal <a href="/tutorials/webcomponents/shadowdom/#toc-separation-separate">insertion points</a> (<code>&lt;content&gt;</code>) in that they&#8217;re placeholders. However, instead of being placeholders for a host&#8217;s <em>content</em>, they&#8217;re hosts for other <em>shadow trees</em>.
It&#8217;s Shadow DOM Inception!</p>
<p>As you can probably imagine, things get more complicated the further you drill down
the rabbit hole. For this reason, the spec is very clear about what happens when
multiple <code>&lt;shadow&gt;</code> elements are in play:</p>
<p class="notice fact">If multiple <code>&lt;shadow&gt;</code> insertion points exist
in a shadow tree, only the first is recognized. The rest are ignored.</p>

<p>Looking back to our original example, the first shadow <code>root1</code> got left off the
invite list. Adding a <code>&lt;shadow&gt;</code> insertion point brings it back:</p>
<pre class="prettyprint"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"example2"</span><span class="tag">&gt;</span><span class="pln">Light DOM</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;script&gt;</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> container </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'#example2'</span><span class="pun">);</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> root1 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> root2 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
root1</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;div&gt;Root 1 FTW&lt;/div&gt;&lt;content&gt;&lt;/content&gt;'</span><span class="pun">;</span><span class="pln">
</span><b><span class="pln">root2</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;div&gt;Root 2 FTW&lt;/div&gt;&lt;shadow&gt;&lt;/shadow&gt;'</span><span class="pun">;</span></b><span class="pln">
</span><span class="tag">&lt;/script&gt;</span></pre>

<div class="demodevtools"> 
<img src="http://rainer.qiniudn.com/shadow-insertion-point.png" title="Shadow insertion points" alt="Shadow insertion points" style="width:250px;">
</div>

<div class="demoarea">
  <div id="example2">Light DOM</div>
</div>

<script>
(function() {
var container = document.querySelector('#example2');
var root1 = container.createShadowRoot();
var root2 = container.createShadowRoot();
root1.innerHTML = '<div>Root 1 FTW</div><content></content>';
root2.innerHTML = '<div>Root 2 FTW</div><shadow></shadow>';
})();
</script>

<p>There are a couple of interesting things about this example:</p>
<ol>
<li>&#8220;Root 2 FTW&#8221; still renders above &#8220;Root 1 FTW&#8221;. This is because of where we&#8217;ve placed
the <code>&lt;shadow&gt;</code> insertion point. If you want the reverse, move the insertion point: <code>root2.innerHTML = '&lt;shadow&gt;&lt;/shadow&gt;&lt;div&gt;Root 2 FTW&lt;/div&gt;';</code>.</li>
<li>Notice there&#8217;s now a <code>&lt;content&gt;</code> insertion point in root1. This makes
the text node &#8220;Light DOM&#8221; come along for the rendering ride.</li>
</ol>
<p><b id="toc-shadow-older">What&#8217;s rendered at &lt;shadow&gt;?</b></p>
<p>Sometimes it&#8217;s useful to know the older shadow tree being rendered at a <code>&lt;shadow&gt;</code>. You can get a reference to that tree through <code>.olderShadowRoot</code>:</p>
<pre class="prettyprint"><b><span class="pln">root2</span><span class="pun">.</span><span class="pln">olderShadowRoot</span></b><span class="pln"> </span><span class="pun">===</span><span class="pln"> root1 </span><span class="com">//true</span></pre>

<h2 id="toc-get-shadowroot">Obtaining a host&#8217;s shadow root</h2>

<p>If an element is hosting Shadow DOM you can access its <a href="#youngest-tree">youngest shadow root</a>
using <code>.shadowRoot</code>:</p>
<pre class="prettyprint"><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> host</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">host</span><span class="pun">.</span><span class="pln">shadowRoot </span><span class="pun">===</span><span class="pln"> root</span><span class="pun">);</span><span class="pln"> </span><span class="com">// true</span><span class="pln">
console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">document</span><span class="pun">.</span><span class="pln">body</span><span class="pun">.</span><span class="pln">shadowRoot</span><span class="pun">);</span><span class="pln"> </span><span class="com">// null</span></pre>

<p>If you&#8217;re worried about people crossing into your shadows, redefine
 <code>.shadowRoot</code> to be null:</p>
<pre class="prettyprint"><span class="typ">Object</span><span class="pun">.</span><span class="pln">defineProperty</span><span class="pun">(</span><span class="pln">host</span><span class="pun">,</span><span class="pln"> </span><span class="str">'shadowRoot'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  </span><span class="kwd">get</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span><span class="pln"> </span><span class="pun">},</span><span class="pln">
  </span><span class="kwd">set</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="pun">}</span><span class="pln">
</span><span class="pun">});</span></pre>

<p>A bit of a hack, but it works. In the end, it&#8217;s important to remember that while amazingly fantastic,
<strong>Shadow DOM has not been designed to be a security feature</strong>. Don&#8217;t rely on it for
complete content isolation.</p>
<h2 id="toc-creating-js">Building Shadow DOM in JS</h2>

<p>If you prefer building DOM in JS, <code>HTMLContentElement</code> and <code>HTMLShadowElement</code>
have interfaces for that.</p>
<pre class="prettyprint"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"example3"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;span&gt;</span><span class="pln">Light DOM</span><span class="tag">&lt;/span&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;script&gt;</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> container </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'#example3'</span><span class="pun">);</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> root1 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> root2 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> div </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
div</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'Root 1 FTW'</span><span class="pun">;</span><span class="pln">
root1</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">div</span><span class="pun">);</span><span class="pln">

 </span><span class="com">// HTMLContentElement</span><span class="pln">
</span><b><span class="kwd">var</span><span class="pln"> content </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'content'</span><span class="pun">);</span><span class="pln">
content</span><span class="pun">.</span><span class="pln">select </span><span class="pun">=</span><span class="pln"> </span><span class="str">'span'</span><span class="pun">;</span></b><span class="pln"> </span><span class="com">// selects any spans the host node contains</span><span class="pln">
root1</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">content</span><span class="pun">);</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> div </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">
div</span><span class="pun">.</span><span class="pln">textContent </span><span class="pun">=</span><span class="pln"> </span><span class="str">'Root 2 FTW'</span><span class="pun">;</span><span class="pln">
root2</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">div</span><span class="pun">);</span><span class="pln">

</span><span class="com">// HTMLShadowElement</span><span class="pln">
</span><b><span class="kwd">var</span><span class="pln"> shadow </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'shadow'</span><span class="pun">);</span></b><span class="pln">
root2</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">shadow</span><span class="pun">);</span><span class="pln">
</span><span class="tag">&lt;/script&gt;</span></pre>

<p>This example is nearly identical to the one in the <a href="#toc-shadow-insertion">previous section</a>.
The only difference is that now I&#8217;m using <code>select</code> to pull out the newly added <code>&lt;span&gt;</code>.</p>
<h2 id="toc-distributed-nodes">Working with insertion points</h2>

<p>Nodes that are selected out of the host element and &#8220;distribute&#8221; into the shadow tree
are called&#8230;drumroll&#8230;distributed nodes! They&#8217;re allowed to cross the shadow boundary
when insertion points invite them in.</p>
<p>What&#8217;s conceptually bizarre about insertion points is that they don&#8217;t physically
move DOM. The host&#8217;s nodes stay intact. Insertion points merely re-project nodes
from the host into the shadow tree. It&#8217;s a presentation/rendering thing: <s>&#8220;Move these nodes over here&#8221;</s> &#8220;Render these nodes at this location.&#8221;</p>
<p class="notice fact">You cannot traverse the DOM into a <code>&lt;content&gt;</code>.</p>

<p>For example:</p>
<pre class="prettyprint"><span class="tag">&lt;div&gt;&lt;h2&gt;</span><span class="pln">Light DOM</span><span class="tag">&lt;/h2&gt;&lt;/div&gt;</span><span class="pln">
</span><span class="tag">&lt;script&gt;</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">).</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
root</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;content select="h2"&gt;&lt;/content&gt;'</span><span class="pun">;</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> h2 </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'h2'</span><span class="pun">);</span><span class="pln">
console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">root</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'content[select="h2"] h2'</span><span class="pun">));</span><span class="pln"> </span><span class="com">// null;</span><span class="pln">
console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">root</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'content'</span><span class="pun">).</span><span class="pln">contains</span><span class="pun">(</span><span class="pln">h2</span><span class="pun">));</span><span class="pln"> </span><span class="com">// false</span><span class="pln">
</span><span class="tag">&lt;/script&gt;</span></pre>

<p>Voilà! The <code>h2</code> isn&#8217;t a child of the shadow DOM. This leads to another tid bit:</p>
<blockquote class="commentary talkinghead">
Insertion points are incredibly powerful. Think of them as a way to create a
&#8220;declarative API&#8221; for your Shadow DOM. A host element can include all the markup in the world,
but unless I invite it into my Shadow DOM with an insertion point, it&#8217;s meaningless.
</blockquote>

<h3 id="toc-getDistributedNodes">Element.getDistributedNodes()</h3>

<p>We can&#8217;t traverse into a <code>&lt;content&gt;</code>, but the <code>.getDistributedNodes()</code> API
allows us to query the distributed nodes at an insertion point:</p>
<pre class="prettyprint"><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"example4"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;h2&gt;</span><span class="pln">Eric</span><span class="tag">&lt;/h2&gt;</span><span class="pln">
  </span><span class="tag">&lt;h2&gt;</span><span class="pln">Bidelman</span><span class="tag">&lt;/h2&gt;</span><span class="pln">
  </span><span class="tag">&lt;div&gt;</span><span class="pln">Digital Jedi</span><span class="tag">&lt;/div&gt;</span><span class="pln">
  </span><span class="tag">&lt;h4&gt;</span><span class="pln">footer text</span><span class="tag">&lt;/h4&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">

</span><span class="tag">&lt;template</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"sdom"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;header&gt;</span><span class="pln">
    </span><span class="tag">&lt;content</span><span class="pln"> </span><span class="atn">select</span><span class="pun">=</span><span class="atv">"h2"</span><span class="tag">&gt;&lt;/content&gt;</span><span class="pln">
  </span><span class="tag">&lt;/header&gt;</span><span class="pln">
  </span><span class="tag">&lt;section&gt;</span><span class="pln">
    </span><span class="tag">&lt;content</span><span class="pln"> </span><span class="atn">select</span><span class="pun">=</span><span class="atv">"div"</span><span class="tag">&gt;&lt;/content&gt;</span><span class="pln">
  </span><span class="tag">&lt;/section&gt;</span><span class="pln">
  </span><span class="tag">&lt;footer&gt;</span><span class="pln">
    </span><span class="tag">&lt;content</span><span class="pln"> </span><span class="atn">select</span><span class="pun">=</span><span class="atv">"h4:first-of-type"</span><span class="tag">&gt;&lt;/content&gt;</span><span class="pln">
  </span><span class="tag">&lt;/footer&gt;</span><span class="pln">
</span><span class="tag">&lt;/template&gt;</span><span class="pln">

</span><span class="tag">&lt;script&gt;</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> container </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'#example4'</span><span class="pun">);</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> root </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> t </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'#sdom'</span><span class="pun">);</span><span class="pln">
</span><span class="kwd">var</span><span class="pln"> clone </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">importNode</span><span class="pun">(</span><span class="pln">t</span><span class="pun">.</span><span class="pln">content</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">);</span><span class="pln">
root</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">clone</span><span class="pun">);</span><span class="pln">

</span><span class="kwd">var</span><span class="pln"> html </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[];</span><span class="pln">
</span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">root</span><span class="pun">.</span><span class="pln">querySelectorAll</span><span class="pun">(</span><span class="str">'content'</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">el</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
  html</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">el</span><span class="pun">.</span><span class="pln">outerHTML </span><span class="pun">+</span><span class="pln"> </span><span class="str">': '</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> nodes </span><span class="pun">=</span><span class="pln"> el</span><span class="pun">.</span><span class="pln">getDistributedNodes</span><span class="pun">();</span><span class="pln">
  </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">nodes</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">node</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    html</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">outerHTML</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">});</span><span class="pln">
  html</span><span class="pun">.</span><span class="pln">push</span><span class="pun">(</span><span class="str">'\n'</span><span class="pun">);</span><span class="pln">
</span><span class="pun">});</span><span class="pln">
</span><span class="tag">&lt;/script&gt;</span></pre>

<div id="example4" style="display:none">
  <h2>Eric</h2>
  <h2>Bidelman</h2>
  <div>Digital Jedi</div>
  <h4>footer text</h4>
</div>

<p><template id="sdom">
  <header>
    <content select="h2"></content>
  </header>
  <section>
    <content select="div"></content>
  </section>
  <footer>
    <content select="h4:first-of-type"></content>
  </footer>
</template></p>
<div id="example4-log" class="demoarea">
 <textarea readonly=""></textarea>
</div>

<script>
(function() {
if ('HTMLTemplateElement' in window) {
  var container = document.querySelector('#example4');

  var root1 = container.createShadowRoot();
  var t = document.querySelector('#sdom');
  var clone = document.importNode(t.content, true);
  root1.appendChild(clone);

  var html = [];
  [].forEach.call(root1.querySelectorAll('content'), function(el) {
    html.push(el.outerHTML + ': ');
    var nodes = el.getDistributedNodes();
    [].forEach.call(nodes, function(node) {
      html.push(node.outerHTML);
    });
    html.push('\n');
  });

  document.querySelector('#example4-log textarea').value = html.join('');
}
})();
</script>

<h3 id="toc-getDestinationInsertionPoints">Element.getDestinationInsertionPoints()</h3>

<p>Similar to <code>.getDistributedNodes()</code>, you can check what insertion points
a node is distributed into by calling its <code>.getDestinationInsertionPoints()</code>:</p>
<pre class="prettyprint"><code><span class="tag">&lt;div</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"host"</span><span class="tag">&gt;</span><span class="pln">
  </span><span class="tag">&lt;h2&gt;</span><span class="pln">Light DOM</span><span class="tag">&lt;/h2&gt;</span><span class="pln">
</span><span class="tag">&lt;/div&gt;</span><span class="pln">

</span><span class="tag">&lt;script&gt;</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> host </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'div'</span><span class="pun">);</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> root1 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> root2 </span><span class="pun">=</span><span class="pln"> container</span><span class="pun">.</span><span class="pln">createShadowRoot</span><span class="pun">();</span><span class="pln">
  root1</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;content select="h2"&gt;&lt;/content&gt;'</span><span class="pun">;</span><span class="pln">
  root2</span><span class="pun">.</span><span class="pln">innerHTML </span><span class="pun">=</span><span class="pln"> </span><span class="str">'&lt;shadow&gt;&lt;/shadow&gt;'</span><span class="pun">;</span><span class="pln">

  </span><span class="kwd">var</span><span class="pln"> h2 </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">querySelector</span><span class="pun">(</span><span class="str">'#host h2'</span><span class="pun">);</span><span class="pln">
  </span><span class="kwd">var</span><span class="pln"> insertionPoints </span><span class="pun">=</span><span class="pln"> h2</span><span class="pun">.</span><span class="pln">getDestinationInsertionPoints</span><span class="pun">();</span><span class="pln">
  </span><span class="pun">[].</span><span class="pln">forEach</span><span class="pun">.</span><span class="pln">call</span><span class="pun">(</span><span class="pln">insertionPoints</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">contentEl</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">contentEl</span><span class="pun">);</span><span class="pln">
  </span><span class="pun">});</span><span class="pln">
</span><span class="tag">&lt;/script&gt;</span></code></pre>
<div id="example5-gip" style="display:none">
  <h2>Light DOM</h2>
</div>

<div id="example5-getDestInsertinoPoints" class="demoarea">
 <textarea readonly=""></textarea>
</div>

<script>
(function() {
if (!!Element.prototype.getDestinationInsertionPoints) { 
  var container = document.querySelector('#example5-gip');
  var h2 = container.querySelector('h2');

  var root1 = container.createShadowRoot();
  var root2 = container.createShadowRoot();
  root1.innerHTML = '<content select="h2"></content>';
  root2.innerHTML = '<shadow></shadow>';

  var html = [];
  var insertionPoints = h2.getDestinationInsertionPoints();
  [].forEach.call(insertionPoints, function(contentEl) {
    html.push(contentEl.outerHTML);
    html.push('\n');
  });

  document.querySelector('#example5-getDestInsertinoPoints textarea').value = html.join('');
}
})();
</script>

<h2 id="toc-shadow-visualizder">Tool: Shadow DOM Visualizer</h2>

<p>Understanding the black magic that is Shadow DOM is difficult. I remember trying
to wrap my head around it for the first time.</p>
<p>To help visualize how Shadow DOM rendering works, I&#8217;ve built a tool
using <a href="http://d3js.org/">d3.js</a>. Both markup boxes on the left-hand side are
editable. Feel free to paste in your own markup and play around to see how things
work and insertion points swizzle host nodes into the shadow tree.</p>
<figure>
<a href="http://html5-demos.appspot.com/static/shadowdom-visualizer/index.html"><img src="http://rainer.qiniudn.com/visualizer.png" title="Shadow DOM Visualizer" alt="Shadow DOM Visualizer"></a>
<figcaption><a href="http://html5-demos.appspot.com/static/shadowdom-visualizer/index.html">Launch Shadow DOM Visualizer</a></figcaption>
</figure>

<p>
<iframe width="420" height="315" src="http://www.youtube.com/embed/qnJ_s58ubxg" frameborder="0" allowfullscreen=""></iframe>
</p>

<p>Give it a try and let me know what you think!</p>
<h2 id="toc-events">Event Model</h2>

<p>Some events cross the shadow boundary and some do not. In the cases where events
cross the boundary, the event target is adjusted in order to maintain the
encapsulation that the shadow root&#8217;s upper boundary provides. That is, <strong>events
are retargeted to look like they&#8217;ve come from the host element rather than internal
elements to the Shadow DOM</strong>.</p>
<p class="tip notice">Access <code>event.path</code> to see the adjusted event path.</p>

<p>If your browser supports Shadow DOM (it does<span class="featuresupported no">n&#8217;t</span>),
you should see a play area below that helps visualize events. Elements in <span style="color:#ffcc00">yellow</span> are part of the Shadow DOM&#8217;s markup. Elements in <span style="color:steelblue">blue</span> are
part of the host element. The <span style="color:#ffcc00">yellow</span> border
around &#8220;I&#8217;m a node in the host&#8221; signifies that it is a distributed node, passing
through the shadow&#8217;s <code>&lt;content&gt;</code> insertion point.</p>
<p>The &#8220;Play Action&#8221; buttons show you different things to try. Give them a go to see
how the <code>mouseout</code> and <code>focusin</code> events bubble up to the main page.</p>
<div id="example5" class="demoarea">
  <div data-host="">
    <div class="blue">I&#8217;m a node in the host</div>
  </div>

  <template style="display:none;"> <!-- display:none used for older browsers -->
    <style>
    .scopestyleforolderbrowsers * {
      border: 4px solid #FC0;
    }
    .scopestyleforolderbrowsers input {
      padding: 5px;
    }
    .scopestyleforolderbrowsers div {
      background: #FC0;
      padding: 5px;
      border-radius: 3px;
      margin: 5px 0;
    }
    content::-webkit-distributed(*) {
      border: 4px solid #FC0;
    }
    ::content * {
      border: 4px solid #FC0;
    }
    </style>
    <section class="scopestyleforolderbrowsers">
      <div>I&#8217;m a node in Shadow DOM</div>
      <div>I&#8217;m a node in Shadow DOM</div>
      <content></content>
      <input type="text" placeholder="I'm in Shadow DOM">
      <div>I&#8217;m a node in Shadow DOM</div>
      <div>I&#8217;m a node in Shadow DOM</div>
    </section>
  </template>

  <aside class="cursor"></aside>

  <div class="buttons">
    <button data-action="playAnimation" data-action-idx="1">Play Action 1</button><br>
    <button data-action="playAnimation" data-action-idx="2">Play Action 2</button><br>
    <button data-action="playAnimation" data-action-idx="3">Play Action 3</button><br>
    <button data-action="clearLog">Clear log</button>
  </div>

  <output></output>
</div>

<script>
(function() {
function stringify(node) {
  return node.outerHTML.match(".*?>")[0].replace('<', '&lt;').replace('>', '&gt;');
}

var out = document.querySelector('#example5 output');
var host = document.querySelector('#example5 [data-host]');
var wrapper = document.querySelector('#example5');

var root = host.createShadowRoot();
root.innerHTML = document.querySelector('#example5 template').innerHTML;

host.addEventListener('mouseout', function(e) {

  out.innerHTML += [
    '<span>[' + e.type + ']</span>', 
    'on:', stringify(e.target) + ',', 
    'from', stringify(e.fromElement),
    '&rarr;', stringify(e.toElement), '<br>'].join(' ');
  out.scrollTop = out.scrollHeight;
});

document.addEventListener('focusin', function(e) {
  out.innerHTML += [
    '<span>[' + e.type + ']</span>',
    'on:', stringify(e.target), '<br>'].join(' ');
  out.scrollTop = out.scrollHeight;
});

function clearLog() {
  out.innerHTML = '';
}

function cleanUpAnimations(node) {
  [].forEach.call(node.classList, function(c) {
    if (c.indexOf('animation') == 0) {
      node.classList.remove(c);
    }
  });
}

function playAnimation(idx) {
  clearLog();
  wrapper.classList.add('playing');
  wrapper.classList.add('animation' + idx);
}

wrapper.addEventListener('webkitAnimationEnd', function(e) {
  this.classList.remove('playing');
  cleanUpAnimations(this);
});

wrapper.addEventListener('animationend', function(e) {
  this.classList.remove('playing');
  cleanUpAnimations(this);
});

document.querySelector('#example5 .buttons').addEventListener('click', function(e) {
  if (e.target.tagName == 'BUTTON') {
    switch(e.target.dataset.action) {
      case 'clearLog':
        clearLog();
        break;
      case 'playAnimation':
        cleanUpAnimations(wrapper);
        playAnimation(parseInt(e.target.dataset.actionIdx));
        break;
      default:
        break;
    }
  }
});

})();
</script>

<p><strong>Play Action 1</strong></p>
<ul>
<li>This one is interesting. You should see a <code>mouseout</code> from the host element (<code>&lt;div data-host&gt;</code>)
to the <span style="color:steelblue">blue</span> node. Even though it&#8217;s a distributed
node, it&#8217;s still in the host, not the ShadowDOM. Mousing further down into 
<span style="color:#ffcc00">yellow</span> again causes a <code>mouseout</code> on the <span style="color:steelblue">blue</span> node.</li>
</ul>
<p><strong>Play Action 2</strong></p>
<ul>
<li>There is one <code>mouseout</code> that appears on host (at the very end). Normally you&#8217;d
see <code>mouseout</code> events trigger for all of the <span style="color:#ffcc00">yellow</span> blocks.
However, in this case these elements are internal to the Shadow DOM and the event
doesn&#8217;t bubble through its upper boundary.</li>
</ul>
<p><strong>Play Action 3</strong></p>
<ul>
<li>Notice that when you click the input, the <code>focusin</code> doesn&#8217;t appear on the
input but on the host node itself. It&#8217;s been retargeted!</li>
</ul>
<h3 id="toc-events-stopped">Events that are always stopped</h3>

<p>The following events never cross the shadow boundary:</p>
<ul>
<li>abort</li>
<li>error</li>
<li>select</li>
<li>change</li>
<li>load</li>
<li>reset</li>
<li>resize</li>
<li>scroll</li>
<li>selectstart</li>
</ul>
<h2 id="toc-conclusion">Conclusion</h2>

<p>I hope you&#8217;ll agree that <strong>Shadow DOM is incredibly powerful</strong>. For the first time ever, we have proper encapsulation without the extra baggage of <code>&lt;iframe&gt;</code>s or other older techniques. </p>
<p>Shadow DOM is certainly complex beast, but it&#8217;s a beast worth adding to the web platform.
Spend some time with it. Learn it. Ask questions.</p>
<p>If you want to learn more, see Dominic&#8217;s intro article <a href="/tutorials/webcomponents/shadowdom/">Shadow DOM 101</a>
and my <a href="/tutorials/webcomponents/shadowdom-201/">Shadow DOM 201: CSS &amp; Styling</a> article.</p>
<p class="small-notice">
Thanks to <a href="/profiles/#dominiccooney">Dominic Cooney</a> and 
<a href="https://plus.google.com/111648463906387632236/posts">Dimitri Glazkov</a> for reviewing
the content of this tutorial.
</p><script>
document.addEventListener('DOMContentLoaded', function(e) {
  if (!isCompatible()) {
    document.body.classList.add('disabledemos');
    $('.featuresupported').removeClass('no');
  }
});
</script>

      </div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Robin</span></span>

      








  


<time datetime="2014-05-16T12:21:36+08:00" pubdate data-updated="true">May 16<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/html5/'>HTML5</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://Robing.github.io/blog/2014/05/16/shadow-dom-301/" data-via="" data-counturl="http://Robing.github.io/blog/2014/05/16/shadow-dom-301/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/05/16/shadow-dom-201/" title="Previous Post: Shadow DOM 201">&laquo; Shadow DOM 201</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/16/shadow-dom-301/">Shadow DOM 301</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/16/shadow-dom-201/">Shadow DOM 201</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/16/shadow-dom-101/">Shadow DOM 101</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/15/css3-animation/">Css3 Animation</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/css3/'>Css3 (1)</a></li>
<li class='category'><a href='/blog/categories/html5/'>HTML5 (3)</a></li>

  </ul>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Robin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'rainboy';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://Robing.github.io/blog/2014/05/16/shadow-dom-301/';
        var disqus_url = 'http://Robing.github.io/blog/2014/05/16/shadow-dom-301/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
